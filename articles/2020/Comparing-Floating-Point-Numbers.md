# å¦‚ä½•æ¯”è¾ƒä¸¤ä¸ªæµ®ç‚¹æ•°

> 2020/11/6 -> 2020/11/10
> 
> å¤«è‡ªç»†è§†å¤§è€…ä¸å°½ï¼Œè‡ªå¤§è§†ç»†è€…ä¸æ˜ã€‚â€”â€”ã€Šåº„å­Â·ç§‹æ°´ã€‹

**æ¯”è¾ƒä¸¤ä¸ªæµ®ç‚¹æ•°æ˜¯å¦ç›¸ç­‰** å¹¶ä¸æ˜¯ä¸€ä¸ªç®€å•çš„é—®é¢˜ï¼š

- ç”±äº æµ®ç‚¹æ•°çš„ç²¾åº¦è¯¯å·®ï¼Œä¸€èˆ¬ä¸èƒ½ä½¿ç”¨ **ç»å¯¹ç›¸ç­‰** æ¯”è¾ƒï¼›
- åŸºäº **ç»å¯¹è¯¯å·®** çš„ **è¿‘ä¼¼ç›¸ç­‰** æ¯”è¾ƒ è¦æ±‚ä½¿ç”¨è€…å¯¹ å…è®¸çš„è¯¯å·®èŒƒå›´ æœ‰æ˜ç¡®çš„é¢„æœŸï¼Œå¹¶ä¸é€šç”¨ï¼›
- åŸºäº **ç›¸å¯¹è¯¯å·®** çš„ **è¿‘ä¼¼ç›¸ç­‰** æ¯”è¾ƒ çœ‹ä¼¼é€šç”¨ï¼Œä½†åˆå¯èƒ½ä¼šåœ¨ 0 é™„è¿‘ â€œæ ½è·Ÿå¤´â€ã€‚ã€‚ã€‚

æœ¬æ–‡ä¸»è¦å‚è€ƒäº† â€œæµ®ç‚¹æ•°ä¸“å®¶â€ [Bruce Dawson](https://randomascii.wordpress.com/) å†™çš„ [Comparing Floating Point Numbers, 2012 Edition](https://randomascii.wordpress.com/2012/02/25/comparing-floating-point-numbers-2012-edition/)ï¼Œä¹Ÿæ¨èä»– [å…³äºæµ®ç‚¹æ•°çš„å…¶ä»–æ–‡ç« ](https://randomascii.wordpress.com/category/floating-point/)ï¼ˆæœ€è¿‘è¿˜ä¸€ç›´åœ¨æ›´æ–° ğŸ‘ï¼‰ã€‚

> æœ¬æ–‡æåˆ°çš„ `Equals()` / `AlmostEqualsAbs()` / `AlmostEqualsRel()` / `AlmostEqualsUlp()` å‡½æ•°çš„å…·ä½“å®ç°å‚è€ƒ [`almost_equals.h`](Comparing-Floating-Point-Numbers/almost_equals.h)ï¼ˆ[åœ¨çº¿æ¼”ç¤º](https://godbolt.org/z/xofPTx)ï¼‰ğŸ‘ˆ

## ç»å¯¹ç›¸ç­‰ï¼Ÿä¸é è°±

æ¯”è¾ƒä¸¤ä¸ªæ•°æ˜¯å¦ç›¸ç­‰ï¼Œæœ€ç›´è§‚çš„ **æ¯”è¾ƒæ–¹æ³•** å°±æ˜¯ç›´æ¥ä½¿ç”¨ `==` è¿›è¡Œæ¯”è¾ƒï¼š

``` cpp
f1 == f2  // Equals()
```

æ ¹æ® [IEEE 754 æµ®ç‚¹æ•°æ ‡å‡†](https://en.wikipedia.org/wiki/IEEE_754)ï¼Œæµ®ç‚¹æ•° $\pm p \cdot b^e$ï¼ˆå…¶ä¸­ $b$ ä¸º å›ºå®šçš„åŸºæ•°ï¼Œ$\pm$ ä¸º ç¬¦å·ä½ï¼Œ$p$ ä¸º å°¾æ•°ï¼Œ$e$ ä¸º æŒ‡æ•°ï¼‰è¡¨ç¤ºä¸º **ç¬¦å·ä½-æŒ‡æ•°-å°¾æ•°** å½¢å¼ï¼š

- **åè¿›åˆ¶æµ®ç‚¹æ•°**ï¼ˆ`b == 10`ï¼‰å°±æ˜¯ æ•°å­¦ä¸­å¸¸ç”¨çš„ [**ç§‘å­¦è®¡æ•°æ³•** _(scientific notation)_](https://en.wikipedia.org/wiki/Scientific_notation)
- **äºŒè¿›åˆ¶æµ®ç‚¹æ•°**ï¼ˆ`b = 2`ï¼‰å¸¸ç”¨äº è®¡ç®—æœºä¸­çš„è¡¨ç¤ºå’Œå­˜å‚¨ï¼Œå…¶ä¸­ [**å•ç²¾åº¦** _(single-precision)_](https://en.wikipedia.org/wiki/Single-precision_floating-point_format) å¯¹åº” 32 ä½ï¼Œ[**åŒç²¾åº¦** _(double-precision)_](https://en.wikipedia.org/wiki/Double-precision_floating-point_format) å¯¹åº” 64 ä½

> åœ¨ C++ ä¸­ï¼Œ`0.1` å±äº åŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œ`0.1f` å±äº å•ç²¾åº¦æµ®ç‚¹æ•°ã€‚
> 
> ä¸ºä»€ä¹ˆè®¡ç®—æœºä½¿ç”¨äºŒè¿›åˆ¶æµ®ç‚¹æ•°ï¼Ÿå› ä¸ºåŸºäºç°æœ‰çš„ CPU æ¶æ„ï¼ŒäºŒè¿›åˆ¶è¿ç®—æ•ˆç‡æ›´é«˜ã€‚

è™½ç„¶åœ¨æ•°å­¦ä¸Šï¼Œå®æ•°æ˜¯ **è¿ç»­çš„** â€”â€” ä»»æ„åè¿›åˆ¶æ•°å’ŒäºŒè¿›åˆ¶æ•°å¯ä»¥ **ç›¸äº’è½¬æ¢**ï¼Œå®ƒä»¬çš„ æµ®ç‚¹æ•°è¡¨ç¤ºå½¢å¼ ä¹Ÿå¯ä»¥ç›¸äº’è½¬æ¢ï¼š

| åè¿›åˆ¶å®šç‚¹æ•° | åè¿›åˆ¶æµ®ç‚¹æ•° | äºŒè¿›åˆ¶å®šç‚¹æ•° | äºŒè¿›åˆ¶æµ®ç‚¹æ•° |
|---|---|---|---|
| `0.125` | $1.25 \times 10^{-1}$ | `0.001` | ($2^{0} + 0) \times 2^{-3}$ |
| `0.1` | $1.0 \times 10^{-1}$ | `0.000110011...` <br/>ï¼ˆ`0011` å¾ªç¯ï¼‰| $(2^{0} + 2^{-1} + 2^{-4} + 2^{-5} + ...) \times 2^{-4}$ |

ä½†æ˜¯åœ¨è®¡ç®—æœºä¸­ï¼Œæ•°å€¼æ˜¯ **ç¦»æ•£çš„** â€”â€” æœ‰é™ç²¾åº¦çš„ äºŒè¿›åˆ¶æµ®ç‚¹æ•° **ä¸èƒ½å‡†ç¡®è¡¨ç¤º** æ‰€æœ‰çš„åè¿›åˆ¶æ•°ï¼ˆ[åœ¨çº¿è½¬æ¢å·¥å…·](https://www.h-schmidt.net/FloatConverter/IEEE754.html)ï¼‰ï¼š

- åè¿›åˆ¶æ•° `0.1` å¯¹åº”çš„ äºŒè¿›åˆ¶æµ®ç‚¹æ•° çš„å°¾æ•° $p$ æ˜¯ `1.100110011...`ï¼ˆ`0011` å¾ªç¯ï¼‰
- ç”±äº 32 ä½å•ç²¾åº¦æµ®ç‚¹æ•° çš„å°¾æ•° $p$ åªæœ‰ 23 ä½ï¼Œåªèƒ½ä¿ç•™å°æ•°ç‚¹å 23 ä½ï¼ˆå³ `1.10011001100110011001101`ï¼‰
- æ‰€ä»¥ï¼Œè¿‘ä¼¼è¡¨ç¤ºçš„ äºŒè¿›åˆ¶æ•° `0.000110011001100110011001101` çº¦ç­‰äº åè¿›åˆ¶æ•° `0.10000000149`ï¼Œå‡ºç°è¯¯å·®

**å­˜åœ¨é—®é¢˜** â€”â€” **æœ‰é™ç²¾åº¦** çš„æµ®ç‚¹æ•°è½¬æ¢ **è¿‘ä¼¼è¡¨ç¤º** ä¼šå¸¦æ¥è¯¯å·®ï¼Œè€Œæµ®ç‚¹æ•°è¿ç®—åˆ™ä¼š **æ”¾å¤§è¯¯å·®**ï¼Œæ‰€ä»¥ åˆ¤æ–­ä¸¤ä¸ªæµ®ç‚¹æ•°ï¼ˆå…¶ä¸­è‡³å°‘ä¸€ä¸ªæ˜¯è¿ç®—ç»“æœï¼‰çš„ **ç»å¯¹ç›¸ç­‰** å¾€å¾€æ˜¯ä¸å¯é çš„ï¼š

``` cpp
float sum = 0.0f;
for (int i = 0; i < 10; ++i) { sum += 0.1f; }
assert(Equals(sum, 1.0f) == false);  // expect true
```

ä¸ºæ­¤ï¼Œç¼–è¯‘å™¨ä¼š **è­¦å‘Š** æµ®ç‚¹æ•°çš„ `==`/`!=` æ¯”è¾ƒï¼š

```
warning: comparing floating point with == or != is unsafe [-Wfloat-equal]
```

**è§£å†³åŠæ³•** â€”â€” ç”±äºè¯¯å·®çš„å­˜åœ¨ï¼Œåªèƒ½ æ¯”è¾ƒä¸¤ä¸ªæµ®ç‚¹æ•°æ˜¯å¦ **è¿‘ä¼¼ç›¸ç­‰**ï¼š

``` cpp
assert(AlmostEqualsAbs(sum, 1.0f) == true);
assert(AlmostEqualsRel(sum, 1.0f) == true);
assert(AlmostEqualsUlp(sum, 1.0f) == true);
```

## è¿‘ä¼¼ç›¸ç­‰ â€”â€” ç»å¯¹è¯¯å·®

æœ€ç®€å•çš„ **æ¯”è¾ƒæ–¹æ³•** æ˜¯ç›´æ¥æ¯”è¾ƒ ä¸¤æ•°å·®å€¼çš„ç»å¯¹å€¼ æ˜¯å¦å°äºä¸€ä¸ª **å…è®¸çš„è¯¯å·®å€¼** `epsilon`ï¼š

``` cpp
fabs(f1 - f2) <= epsilon  // AlmostEqualsAbs()
```

å…¶ä¸­ï¼Œ`epsilon` å¸¸ç”¨ [`FLT_EPSILON` / `DBL_EPSILON`](https://en.cppreference.com/w/cpp/types/numeric_limits/epsilon)ï¼Œè¡¨ç¤ºåœ¨ å•ç²¾åº¦ `1.0f` / åŒç²¾åº¦ `1.0` é™„è¿‘çš„æœ€å°è¯¯å·®ã€‚

**å­˜åœ¨é—®é¢˜** â€”â€” ç”±äº **ç»å¯¹è¯¯å·®** æ˜¯ä¸€ä¸ªå›ºå®šå€¼ï¼Œä¸ä¸€å®šé€‚ç”¨äº ä»»æ„æµ®ç‚¹æ•°çš„æ¯”è¾ƒï¼š

``` cpp
assert(AlmostEqualsAbs(67329.234f, 67329.242f) == false);  // expect true
assert(AlmostEqualsAbs(1.2e-32f, 2.4e-32f) == true);       // expect false
```

- å½“æ¯”è¾ƒçš„ä¸¤ä¸ªæ•° è¿œå¤§äº `1` æ—¶ï¼Œ`FLT_EPSILON`/`DBL_EPSILON` å…è®¸çš„è¯¯å·®è¿‡å°ï¼ˆä¾‹å¦‚ï¼Œè™½ç„¶ `67329.234f` äº§ç”Ÿè¯¯å·®åä¼šè¢« è¿‘ä¼¼è¡¨ç¤ºä¸º æœ€è¿‘çš„ä¸‹ä¸€ä¸ªæµ®ç‚¹æ•° `67329.242f`ï¼Œä½†å·®å€¼è¿œå¤§äº `FLT_EPSILON`ï¼Œæ‰€ä»¥è¢«è¯¯åˆ¤ä¸ºä¸ç›¸ç­‰ ğŸ™ƒï¼‰
- å½“æ¯”è¾ƒçš„ä¸¤ä¸ªæ•° è¿œå°äº `1` æ—¶ï¼Œ`FLT_EPSILON`/`DBL_EPSILON` å…è®¸çš„è¯¯å·®è¿‡å¤§ï¼ˆä¾‹å¦‚ï¼Œå°½ç®¡ `1.2e-32f` å’Œ `2.4e-32f` ç›¸å·®äº†ä¸€å€ï¼Œåº”è¯¥è¢«è®¤ä¸ºä¸ç›¸ç­‰ï¼Œä½†å·®å€¼è¿œå°äº `FLT_EPSILON`ï¼Œæ‰€ä»¥è¢«è¯¯åˆ¤ä¸ºè¿‘ä¼¼ç›¸ç­‰ ğŸ™ƒï¼‰

**è§£å†³åŠæ³•** â€”â€” éœ€è¦å€ŸåŠ© **ç›¸å¯¹è¯¯å·®** å¼¥è¡¥ä¸Šè¿°å±€é™æ€§ï¼š

``` cpp
assert(AlmostEqualsRel(67329.234f, 67329.242f) == true);
assert(AlmostEqualsUlp(67329.234f, 67329.242f) == true);
assert(AlmostEqualsRel(1.2e-32f, 2.4e-32f) == false);
assert(AlmostEqualsUlp(1.2e-32f, 2.4e-32f) == false);
```

## è¿‘ä¼¼ç›¸ç­‰ â€”â€” ç›¸å¯¹è¯¯å·®

**a)** ä¸€ç§ **æ¯”è¾ƒæ–¹æ³•** æ˜¯ æŠŠç»å¯¹çš„ `epsilon` æ”¾ç¼©åˆ°å¾…æ¯”è¾ƒæ•°çš„ **é‡çº§** _(magnitude)_ï¼Œå³ `epsilon` ä¹˜ä»¥ ä¸¤æ•°ç»å¯¹å€¼çš„è¾ƒå¤§å€¼ï¼š

``` cpp
fabs(f1 - f2) <= epsilon * std::max(fabs(f1), fabs(f2))  // AlmostEqualsRel()
```

ç„¶è€Œï¼Œè¿™ç§æ¯”è¾ƒæ–¹æ³•ï¼š

- ä¸€æ–¹é¢ å¯èƒ½ **ä¸‹æº¢** _(underflow)_ â€”â€” å¦‚æœä¸¤æ•°çš„ ç»å¯¹å€¼éƒ½å¾ˆå°ï¼Œé‚£ä¹ˆä¹˜ä¸Š epsilon åå¯èƒ½å¾—åˆ° `0.0`ï¼Œå¯¼è‡´åˆ¤æ–­å¤±è´¥
- å¦ä¸€æ–¹é¢ **å¹¶ä¸é«˜æ•ˆ** â€”â€” éœ€è¦è¿›è¡Œå¤šæ¬¡ **æµ®ç‚¹æ•°è¿ç®—**ï¼ˆé™¤äº†æ±‚ç»å¯¹å€¼å¤–ï¼Œä¸¤æ¬¡æ¯”è¾ƒã€ä¸€æ¬¡ä¹˜æ³•ã€ä¸€æ¬¡å‡æ³•ï¼‰

æ‰€ä»¥ï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„æ¯”è¾ƒæ–¹æ³•å‘¢ï¼Ÿ

**b)** å¦ä¸€ç§æ–¹æ³•æ˜¯ åŸºäºæµ®ç‚¹æ•°äºŒè¿›åˆ¶è¡¨ç¤ºçš„ [ULP _(unit in the last place)_](https://en.wikipedia.org/wiki/Unit_in_the_last_place) è¿›è¡Œæ¯”è¾ƒï¼š
  - æ ¹æ® IEEE 754 æ ‡å‡†ï¼Œ**ç›¸é‚»** ä¸¤ä¸ªæµ®ç‚¹æ•°çš„ **äºŒè¿›åˆ¶è¡¨ç¤º** æ°å¥½ä¹Ÿæ˜¯ç›¸é‚»çš„ â€”â€” ç›¸é‚»ä¸¤ä¸ªæµ®ç‚¹æ•°ä¹‹é—´çš„è·ç¦» å°±æ˜¯ â€œå®ƒä»¬çš„ ULPâ€ï¼ˆå®šä¹‰å‚è€ƒï¼š[What Every Computer Scientist Should Know About Floating-Point Arithmetic by _David Goldberg_](https://www.itu.dk/~sestoft/bachelor/IEEE754_article.pdf)ï¼‰
  - ä¾‹å¦‚ï¼Œè·ç¦» `1.0f` æœ€è¿‘çš„ä¸‹ä¸€ä¸ªæµ®ç‚¹æ•°æ˜¯ [`nextafter(1.0f)`](https://en.cppreference.com/w/cpp/numeric/math/nextafter)ï¼Œæ°å¥½ç­‰äº `1.0f + FLT_EPSILON`ï¼Œæ‰€ä»¥ `ULP(1.0f)` ç­‰äº [`FLT_EPSILON`](https://en.cppreference.com/w/cpp/types/numeric_limits/epsilon)ï¼ˆå³ $2^{-23}$ï¼‰ï¼š

| åè¿›åˆ¶å®šç‚¹æ•° | äºŒè¿›åˆ¶æµ®ç‚¹æ•° | äºŒè¿›åˆ¶è¡¨ç¤º |
|---|---|---|
| `1.0f` | $(2^{0} + 0) \times 2^{0}$ | `0 01111111 00000000000000000000000` |
| `nextafter(1.0f)` | $(2^{0} + 2^{-23}) \times 2^{0}$ | `0 01111111 00000000000000000000001` |

ç›´è§‚ä¸Šï¼Œ**æ¯”è¾ƒæ–¹æ³•** å¾ˆç®€å• â€”â€” æ¯”è¾ƒæµ®ç‚¹æ•°çš„ **äºŒè¿›åˆ¶è¡¨ç¤º** çš„ å·®å€¼çš„ç»å¯¹å€¼ æ˜¯å¦å°äºä¸€ä¸ª **å…è®¸çš„ ULP è¯¯å·®** `max_ulp`ï¼š

``` cpp
abs(Biased(Bits(f1)) - Biased(Bits(f2))) <= max_ulp  // AlmostEqualsUlp()
```

- é¦–å…ˆï¼Œå°†ä¸¤ä¸ª å•ç²¾åº¦/åŒç²¾åº¦ **æµ®ç‚¹æ•°** ç›´æ¥ **æŒ‰ä½** è½¬æˆ 32/64 ä½ **æ•´æ•°**
- ç„¶åï¼Œç”±äº è¿™ä¸¤ä¸ªæ•´æ•°è¡¨ç¤ºä¸º [**ç¬¦å·ä½-æ•°å€¼** _(sign-magnitude)_](https://en.wikipedia.org/wiki/Signed_number_representations#Signed_magnitude_representation) æ ¼å¼ï¼Œå¯¼è‡´ [`+0`/`-0`](https://en.wikipedia.org/wiki/Signed_zero) çš„è¡¨ç¤ºå½¢å¼ä¸ä¸€è‡´ï¼Œæ‰€ä»¥éœ€è¦è½¬æ¢ä¸º è¿ç»­èŒƒå›´ ä¸Šçš„ **æ— ç¬¦å·æ•´æ•°**
- æœ€åï¼Œå†æ¯”è¾ƒ ä¸¤ä¸ªæ— ç¬¦å·æ•´æ•° **å·®å€¼çš„ç»å¯¹å€¼** æ˜¯å¦å°äº `max_ulp`

ç›¸å¯¹äºæ”¾ç¼© epsilon çš„æ–¹æ³•ï¼Œè¿™ç§æ¯”è¾ƒæ–¹æ³•ï¼š

- ä¸€æ–¹é¢ æ²¡æœ‰æµ®ç‚¹æ•°ä¹˜æ³•çš„ ä¸‹æº¢é—®é¢˜
- å¦ä¸€æ–¹é¢ åœ¨å¤šæ•°ç°ä»£å¤„ç†å™¨ä¸Šï¼Œè¿ç®— **æ•ˆç‡æ›´é«˜**ï¼ˆè®¡ç®— **æ¬¡æ•°æ›´å°‘**ï¼Œ[åªéœ€è¦è¿›è¡Œ **æ•´æ•°è¿ç®—**ï¼Œä¸æ¶‰åŠä»»ä½• **æµ®ç‚¹æ•°è¿ç®—**](https://stackoverflow.com/questions/2550281/floating-point-vs-integer-calculations-on-modern-hardware)ï¼‰

> æ ¹æ® [`gtest-internal.h`](https://github.com/google/googletest/blob/master/googletest/include/gtest/internal/gtest-internal.h)ï¼Œä¸€èˆ¬ `max_ulp` å–å€¼ä¸º `4`ï¼š
> 
> The maximum error of a single floating-point operation is 0.5
> units in the last place.  On Intel CPU's, all floating-point
> calculations are done with 80-bit precision, while double has 64
> bits.  Therefore, 4 should be enough for ordinary use.
> 
> å¦å¤–ï¼Œåœ¨å®é™…ä»£ç ä¸­ï¼Œè¿˜éœ€è¦å¤„ç† [`+âˆ`/`-âˆ`](https://en.wikipedia.org/wiki/Infinity) å’Œ [`NaN` _(not a number)_](https://en.wikipedia.org/wiki/NaN) ç­‰æƒ…å†µã€‚ï¼ˆæµ‹è¯•ç”¨ä¾‹ å‚è€ƒ [`gtest_unittest.cc`](https://github.com/google/googletest/blob/master/googletest/test/gtest_unittest.cc)ï¼‰

å†ä¸¾ä¸ªä¾‹å­ï¼Œ`4.0f` å’Œ å®ƒçš„ä¸‹ä¸€ä¸ªæµ®ç‚¹æ•° `nextafter(4.0f)` ä¹‹é—´ç›¸å·®äº† 4 å€çš„ `FLT_EPSILON`ï¼ˆå³ `ULP(4.0f) == 4 FLT_EPSILON`ï¼‰ï¼š

| åè¿›åˆ¶å®šç‚¹æ•° | äºŒè¿›åˆ¶æµ®ç‚¹æ•° | äºŒè¿›åˆ¶è¡¨ç¤º |
|---|---|---|
| `4.0f` | $(2^{0} + 0) \times 2^{2}$ | `0 10000001 00000000000000000000000` |
| `nextafter(4.0f)` | $(2^{0} + 2^{-23}) \times 2^{2}$ | `0 10000001 00000000000000000000001` |

[align-center]

![ulp-vs-epsilon](Comparing-Floating-Point-Numbers/ulp-vs-epsilon.png)

æ‰€ä»¥ï¼Œæ— æ³•ä½¿ç”¨ **ç»å¯¹è¯¯å·®** åˆ¤æ–­ `4.0f` å’Œ `nextafter(4.0f)` æ˜¯å¦è¿‘ä¼¼ç›¸ç­‰ï¼Œåªèƒ½ä½¿ç”¨ **ç›¸å¯¹è¯¯å·®**ï¼š

``` cpp
const float next_after_4 = nextafter(4.0f, FLT_MAX);
assert(AlmostEqualsAbs(4.0f, next_after_4) == false);  // expect true
assert(AlmostEqualsRel(4.0f, next_after_4) == true);
assert(AlmostEqualsUlp(4.0f, next_after_4) == true);
```

**å­˜åœ¨é—®é¢˜** â€”â€” å¦‚æœéœ€è¦æ¯”è¾ƒçš„æ•°å€¼ **éå¸¸æ¥è¿‘ 0**ï¼Œå°±æ— æ³•ä½¿ç”¨ **ç›¸å¯¹è¯¯å·®** å’Œ 0 æ¯”è¾ƒï¼š

``` cpp
assert(AlmostEqualsRel(FLT_EPSILON, 0.0f) == false);  // expect true
assert(AlmostEqualsUlp(FLT_EPSILON, 0.0f) == false);  // expect true
```

- è™½ç„¶ `nextafter(1.0f)` å’Œ `1.0f` ç›¸å·® `FLT_EPSILON`ï¼Œ**ä¸¤è€…è¿‘ä¼¼ç›¸ç­‰**
- ä½†æ˜¯ `FLT_EPSILON`ï¼ˆå³ `nextafter(1.0f) - 1.0f`ï¼‰å’Œ 0 ç›¸æ¯”ï¼Œ**å¹¶ä¸è¿‘ä¼¼ç›¸ç­‰** ğŸ™ƒ

å³ä½¿æ”¾å¤§å…è®¸çš„è¯¯å·®èŒƒå›´ï¼Œä¹Ÿä¸ä¸€å®šå¯è¡Œ â€”â€” å› ä¸ºå’Œ 0 æ¯”èµ·æ¥ï¼Œâ€œç›¸å¯¹è¯¯å·®â€ è¿˜æ˜¯å¤ªå¤§äº† â€”â€” åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒåŸºäºç›¸å¯¹è¯¯å·®çš„æ¯”è¾ƒæ–¹æ³• å¾€å¾€æ˜¯ **æ²¡æœ‰å®é™…æ„ä¹‰** çš„ï¼š

``` cpp
assert(AlmostEqualsRel(FLT_EPSILON, 0.0f, 0.1f) == false);  // expect true
assert(AlmostEqualsUlp(FLT_EPSILON, 0.0f, 1000) == false);  // expect true
```

**è§£å†³åŠæ³•** â€”â€” åªèƒ½ä½¿ç”¨ **ç»å¯¹è¯¯å·®** è¿›è¡Œ â€œæœ‰æ„ä¹‰â€ çš„æ¯”è¾ƒï¼š

``` cpp
assert(AlmostEqualsAbs(FLT_EPSILON, 0.0f) == true);
```

## å¸¸é‡çš„é™·é˜±

éœ€è¦æ³¨æ„ï¼Œ**ä»ä½ç²¾åº¦è½¬ä¸ºé«˜ç²¾åº¦**ï¼ˆä» `float` è½¬ä¸º `double`ï¼‰ä¼šå¯¼è‡´ â€œå·¨å¤§â€ çš„è¯¯å·®ï¼š

``` cpp
assert(Equals<double>(0.1f, 0.1) == false);           // expect true
assert(AlmostEqualsAbs<double>(0.1f, 0.1) == false);  // expect true
assert(AlmostEqualsRel<double>(0.1f, 0.1) == false);  // expect true
assert(AlmostEqualsUlp<double>(0.1f, 0.1) == false);  // expect true
```

ä¸ºæ­¤ï¼Œå¯ä»¥é€šè¿‡ **æ”¾å¤§å…è®¸çš„è¯¯å·®**ï¼Œç¼“è§£ç²¾åº¦ä¸¢å¤±çš„é—®é¢˜ï¼š

``` cpp
assert(AlmostEqualsAbs<double>(0.1f, 0.1, static_cast<double>(FLT_EPSILON)) ==
       true);
assert(AlmostEqualsRel<double>(0.1f, 0.1, static_cast<double>(FLT_EPSILON)) ==
       true);
assert(AlmostEqualsUlp<double>(0.1f, 0.1, FLT_EPSILON / DBL_EPSILON) == true);
```

ç›¸åï¼Œ**ä»é«˜ç²¾åº¦è½¬ä¸ºä½ç²¾åº¦**ï¼ˆä» `double` è½¬ä¸º `float`ï¼‰åˆ™ä¼šæŠ¹é™¤ç»†å¾®çš„è¯¯å·®ï¼š

``` cpp
assert(Equals(static_cast<float>(0.1), 0.1f) == true);
```

å¦å¤–ï¼Œç”±äºç²¾åº¦çš„é™åˆ¶ï¼Œä¸¤ä¸ª **éå¸¸æ¥è¿‘**ï¼ˆç›¸å·® `0 ULP`ï¼‰çš„ åè¿›åˆ¶å®šç‚¹æ•° **å­—é¢é‡** _(literal)_ï¼Œåªèƒ½è¡¨ç¤ºä¸º ç›¸åŒçš„ äºŒè¿›åˆ¶æµ®ç‚¹æ•°ï¼š

``` cpp
assert(Equals(67329.234f, 67329.235f) == true);  // expect false
```

## å†™åœ¨æœ€å

[Bruce Dawson çš„æ€»ç»“æ˜¯ â€œæ²¡æœ‰é“¶å¼¹â€](https://randomascii.wordpress.com/2012/02/25/comparing-floating-point-numbers-2012-edition/) â€”â€” åœ¨æ¯”è¾ƒä¸¤ä¸ªæµ®ç‚¹æ•°æ˜¯å¦è¿‘ä¼¼ç›¸ç­‰æ—¶ï¼Œéœ€è¦æ ¹æ®å…·ä½“åœºæ™¯ï¼Œé€‰æ‹©æ›´åˆé€‚çš„æ¯”è¾ƒæ–¹æ³•ï¼š

- å¦‚æœ è¦åˆ¤æ–­ ä¸€ä¸ªæµ®ç‚¹æ•° **æ˜¯å¦æ¥è¿‘ 0**
  - åº”è¯¥ä½¿ç”¨ **ç»å¯¹è¯¯å·®**
  - å› ä¸ºæ­¤æ—¶çš„ **ç›¸å¯¹è¯¯å·®** æ²¡æœ‰å®é™…æ„ä¹‰
- å¦‚æœ è¦æ¯”è¾ƒçš„ ä¸¤ä¸ªæµ®ç‚¹æ•° **éƒ½ä¸æ˜¯ 0**
  - ä¸€èˆ¬ä½¿ç”¨æ›´é€šç”¨çš„ **ç›¸å¯¹è¯¯å·®**
  - ä½†å¦‚æœèƒ½ **æå‰åˆ¤æ–­** å…è®¸çš„è¯¯å·®èŒƒå›´ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ **ç»å¯¹è¯¯å·®**
- æ‰€ä»¥ï¼Œ**å¹¶ä¸å­˜åœ¨** åˆ¤æ–­ **ä»»æ„** ä¸¤ä¸ªæµ®ç‚¹æ•° çš„é€šç”¨æ–¹æ³• ğŸ™ƒ

ç°å®ä¸–ç•Œä¹Ÿä¸€æ · â€”â€”

- å¯¹äºæœ‰é’±çš„äººæ¥è¯´ï¼Œ`AlmostEquals(ç™¾å…ƒé’ç¥¨, 0) == true`
- å¯¹äºæ²¡é’±çš„äººæ¥è¯´ï¼Œ`AlmostEquals(ä¸€å…ƒç¡¬å¸, 0) == false`

æœ€åï¼Œä»Šå¹´åŒåä¸€å°†æŠ½å–ä¸€ååœ¨ **ä¸‹æ–¹ç•™è¨€** çš„å¹¸è¿è¯»è€…ï¼Œ~~é€å‡ºä¸€å¼  **ç›èæ‹‰è’‚ 5 å…ƒä»£é‡‘åˆ¸**~~ ğŸ™ƒ

[align-center]

[img=width:80%]

![Maserati-Voucher](Comparing-Floating-Point-Numbers/Maserati-Voucher.jpg)

[align-center]

ï¼ˆå›¾ç‰‡æ¥è‡ªç½‘ç»œï¼‰

å¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œ**æ¬¢è¿äº¤æµ**ã€‚ğŸ˜„

Delivered under MIT License &copy; 2020, BOT Man
