# 编译加速 - 合并源文件

MindSpore包含1000+算子，每个算子有独立的infer和不同后端kernel文件。大量源文件导致编译性能低下。

且各算子源文件包含大量重复内容，如不同算子kernel引用了相同的定义了公共常量的头文件，
则每个kernel编译生成的目标文件都会包含一份这些常量的副本。

为了优化编译时间和目标文件体积，决定将不同算子的infer和kernel源文件合并后编译。具体的合并方案为

- 按照算子首字母进行合并，生成合并文件如ops_infer_a.cc, ops_infer_b.cc, ...
- 文件行数超过10000行时，另起新合并文件，合并文件后缀+1, 如ops_infer_s1.cc
- 合并生成的文件和上次编译的合并文件做md5值比较，确认内容有变化后更新文件内容

为了解决合并后符号名冲突问题，使用脚本为将每个算子源文件包含在以算子名命名的命名空间中。

**结果**：

|                | Release        | Debug         |
|----------------|---------------|---------------|
| Compile Time   | 123min->75min | 123min->83min |
| Whl Size       | 473M->418M    | 5.3G->3.4G   |

在编译时间和目标文件体积上有较大提升。