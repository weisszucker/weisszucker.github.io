# ä¸€åˆ‡çš†å¯è°ƒè¯•

> 2021/1/10 -> 2021/2/12
> 
> Debugging is twice as hard as writing the code in the first place. â€”â€” Kernighanâ€™s Law

## å†™åœ¨å‰é¢ TL;DR [no-toc]

> åœ¨ä¸€æ¬¡å­¦æ ¡ç¤¾å›¢çš„æŠ€æœ¯åˆ†äº«ä¸­ï¼Œä¸¤ä½ â€œé»‘å®¢â€ åŒå­¦åˆ†äº«äº†ï¼šå¦‚ä½•ç”¨ **ä¸€ä¸ªä¸‹åˆçš„æ—¶é—´** ç ´è§£æŸè‹±è¯­å­¦ä¹ å®¢æˆ·ç«¯ â€”â€” å­¦ç”Ÿæ— éœ€å­¦ä¹ è¯¾ç¨‹ï¼Œå³å¯è‡ªåŠ¨å®Œæˆè€ƒè¯•ã€‚
> 
> ä»¤æˆ‘å°è±¡æœ€æ·±åˆ»çš„æ˜¯ï¼šåŸæœ¬ç”¨äºè°ƒæ•´éŸ³é‡çš„æ»‘å—ï¼Œè¢«é­”æ”¹ç”¨æ¥è¾“å…¥è€ƒè¯•å¾—åˆ† â€”â€” åˆ©ç”¨åŠ¨æ€è§„åˆ’ï¼Œæ¨¡æ‹Ÿç­”é”™ä¸€äº›é¢˜ç›®ï¼Œæœ€åæäº¤ç¬¦åˆé¢„æœŸæ€»åˆ†çš„ç­”æ¡ˆï¼ˆæ¯•ç«Ÿä¸èƒ½å…¨æ˜¯æ»¡åˆ† ğŸ˜¶ï¼‰ã€‚
> 
> å½“æ—¶ï¼Œæˆ‘ â€œå¹¼å°çš„å¿ƒçµâ€ å—åˆ°äº† å·¨å¤§çš„éœ‡æ’¼ â€”â€” åªè¦å­¦ä¼šäº† **é€†å‘å’Œè°ƒè¯•**ï¼Œå°±å¯ä»¥ â€œéšå¿ƒæ‰€æ¬²â€ äº†ï¼ˆå½“ç„¶ä¹Ÿå¾— â€œä¸é€¾çŸ©â€ ğŸ™‚ï¼‰ã€‚äºæ˜¯ï¼Œæˆ‘å¼€å§‹å‘ä»–ä»¬å­¦ä¹ ï¼

ç°åœ¨ï¼Œæˆ‘é€æ¸å­¦ä¼šäº† â€œåœ¨è°ƒè¯•å™¨é‡Œçœ‹ä¸–ç•Œâ€ï¼Œä¹Ÿæé«˜äº†æ’æŸ¥é—®é¢˜çš„é€Ÿåº¦ã€‚æœ¬æ–‡å…ˆåˆ†äº«ä¸¤ä¸ªæ•…äº‹ï¼Œå†æ€»ç»“ä¸€äº›å¿ƒå¾—å’ŒæŠ€å·§ï¼š

[TOC]

## å…³äºé€†å‘çš„å®¢åœºä½œæˆ˜

> ğŸ’¡ ç”±äºæ‹¿ä¸åˆ°è¢«è°ƒè¯•å¯¹è±¡çš„ ç¬¦å·å’Œæºç ï¼Œä¸€èˆ¬éœ€è¦å€ŸåŠ©ä¸“ä¸šçŸ¥è¯†ï¼Œé€šè¿‡é€†å‘æŠ€æœ¯ï¼Œæ ¹æ®ç¨‹åºè¡Œä¸ºï¼Œé¡ºè—¤æ‘¸ç“œï¼Œæ¨æ•²é€»è¾‘ã€‚

### ç³Ÿç³•çš„ç”¨æˆ·ä½“éªŒ

ç”±äºå…¬å¸é…äº† MacBook Proï¼Œä¸å¾—ä¸ç”¨å®ƒ ~~ï¼ˆç—›è‹¦çš„ ğŸ˜­ï¼‰~~ è¿›è¡Œæ—¥å¸¸å·¥ä½œã€‚~~å½“ç„¶ï¼Œä½œä¸ºéŸ³å“è¿˜æ˜¯å¾ˆä¸é”™çš„ã€‚ã€‚ã€‚ï¼ˆä¸è¿‡å°±æ˜¯æœ‰ç‚¹è´µ ğŸ˜¶ï¼‰~~

ç„¶è€Œ macOS ä¸Šçš„å¾ˆå¤šè½¯ä»¶ï¼ˆå°¤å…¶æ˜¯å›½äº§è½¯ä»¶ï¼‰éƒ½æ²¡æœ‰ç»è¿‡ä»”ç»†æ‰“ç£¨ â€”â€” è¦ä¹ˆæ˜¯åŠŸèƒ½ç¼ºå¤±ï¼ˆè¿™è®©æˆ‘å›å¿†èµ·ç”¨ Windows Phone çš„ä¸‰å¹´æ—¶å…‰ï¼‰ï¼Œè¦ä¹ˆæ˜¯ç”¨èµ·æ¥ç¡Œç¡¬ï¼ˆå¾ˆå¤šæ˜æ˜¾çš„ bug éƒ½æ²¡äººä¿®ï¼‰ã€‚

å…¶ä¸­æœ‰å¾ˆå¤šè½¯ä»¶éƒ½å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šä»–ä»¬çš„æ•´ä¸ªæ ‡é¢˜æ éƒ½èƒ½æ‹–åŠ¨ï¼Œä½†åªæœ‰ä¸ŠåŠéƒ¨åˆ†æ”¯æŒåŒå‡»æ”¾ç¼©ï¼Œä¸‹åŠéƒ¨åˆ†å´åªèƒ½æ‹–åŠ¨ â€”â€”

![MacQQ-Bug](Debug-Everywhere/MacQQ-Bug.png)

å¦‚æœä¸å°å¿ƒåŒå‡»äº†ä¸‹åŠéƒ¨åˆ†ï¼Œæ€»ä»¥ä¸ºæ˜¯ç¨‹åºå¡ä½äº†ï¼›ä½†æ˜¯æŠŠé¼ æ ‡å¾€ä¸Šç§»ä¸€äº›å†åŒå‡»ï¼Œåˆå¯ä»¥æ”¾ç¼©äº† â€”â€” æ„Ÿè§‰å—åˆ°äº†æ¬ºéª— ğŸ˜¡ã€‚

ä½œä¸ºå¤šå¹´ Windows ç”¨æˆ·ï¼Œå®åœ¨å¿æ— å¯å¿ï¼Œäºæ˜¯ï¼Œå…ˆä»æœ€å¸¸ç”¨çš„ QQ ä¸‹æ‰‹ â€”â€”

### ä¸è¯´åˆ«çš„ï¼Œä¸Šè°ƒè¯•å™¨

æ°å¥½ macOS ä¸Šé¢„è£…æœ‰ lldbï¼ˆç»ˆç«¯é‡Œç›´æ¥æ•² lldb å³å¯å®‰è£… ğŸ‘ï¼‰ï¼Œè¿™æ¬¡å°±æ²¡æœ‰ç”¨ gdbï¼ˆå½“ç„¶ï¼ŒWinDbg ä¸æ”¯æŒ macOS ğŸ™ƒï¼‰ã€‚

> ğŸ’¡ å¦‚æœä¸çŸ¥é“å¦‚ä½•ä½¿ç”¨è°ƒè¯•å™¨ï¼Œæ¨èé˜…è¯» [LLDB æ•™ç¨‹](https://lldb.llvm.org/use/tutorial.html)ï¼›å¦‚æœä¸ç†Ÿæ‚‰ lldb å‘½ä»¤ï¼Œå¯ä»¥å‚è€ƒ [GDB/LLDB å‘½ä»¤æ˜ å°„è¡¨](https://lldb.llvm.org/use/map.html)ã€‚

ç”±äº QQ çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæœ¬æ–‡ä½¿ç”¨çš„æ˜¯æœ€æ–°çš„ [6.7.3 ç‰ˆæœ¬](https://dldir1.qq.com/qqfile/QQforMac/QQ_6.7.3.dmg)ï¼‰ä½¿ç”¨äº†ç­¾åï¼Œ[è°ƒè¯•å‰éœ€è¦å…ˆå»æ‰ç­¾å](https://reverseengineering.stackexchange.com/questions/13622/remove-code-signature-from-a-mac-binary)ï¼š

```
codesign --remove-signature /Applications/QQ.app/Contents/MacOS/QQ
```

> ğŸ’¡ ç£¨åˆ€ä¸è¯¯ç æŸ´å·¥ â€”â€” èƒŒæ™¯è°ƒç ”ï¼Œéå¸¸å…³é”®ã€‚

æ‹¿åˆ°ä¸€ä¸ªæ–°é—®é¢˜åï¼Œéœ€è¦å…ˆç®€å•äº†è§£ä¸€äº›ç›¸å…³çŸ¥è¯†ï¼š

- [æ ¹æ®ç½‘å‹çš„å›ç­”](https://apple.stackexchange.com/questions/95681/how-can-i-change-os-x-double-click-on-title-bar-to-be-like-windows/232153#232153)ï¼Œæˆ‘ä»¬çŸ¥é“ï¼š
  - åŒå‡»çš„è‹±æ–‡æ˜¯ double click
  - æ ‡é¢˜æ çš„è‹±æ–‡æ˜¯ title barï¼ˆåè¾¹å‘ç°åº”è¯¥æ˜¯ titlebar ğŸ™ƒï¼‰
  - æ”¾ç¼©çª—å£çš„è‹±æ–‡æ˜¯ zoom window
  - è€Œè¿™ä¸ªåŠŸèƒ½æ˜¯ä» macOS Catalina 10.15 å¼€å§‹æ”¯æŒçš„
- macOS åŸºäº [Cocoa UI æ¡†æ¶](https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/OSX_Technology_Overview/CocoaApplicationLayer/CocoaApplicationLayer.html)ï¼Œç”¨çš„æ˜¯ [Objective-C è¯­è¨€](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ProgrammingWithObjectiveC/Introduction/Introduction.html)ï¼ˆæˆ‘æƒŠå–œçš„å‘ç° â€”â€” å³ä½¿ä¸ä¼šï¼Œä¹Ÿä¸å½±å“è°ƒè¯• ğŸ™‚ï¼‰ï¼Œæ ¸å¿ƒæ¨¡å—æ˜¯ [AppKit](https://developer.apple.com/documentation/appkit?language=objc) æ¡†æ¶
- [æ ¹æ®é¼ æ ‡ç›¸å…³çš„æ–‡æ¡£](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/EventOverview/HandlingMouseEvents/HandlingMouseEvents.html#//apple_ref/doc/uid/10000060i-CH6-SW17)ï¼Œæˆ‘ä»¬çŸ¥é“ï¼š
  - é¼ æ ‡ç‚¹å‡»äº‹ä»¶åˆ†ä¸º [`mouseDown:`](https://developer.apple.com/documentation/appkit/nsresponder/1524634-mousedown) å’Œ [`mouseUp:`](https://developer.apple.com/documentation/appkit/nsresponder/1535349-mouseup)ï¼ˆæ³¨æ„ç»“å°¾çš„å†’å· `:`ï¼‰
  - é¼ æ ‡äº‹ä»¶çš„ç±»å‹æ˜¯ [`NSEvent`](https://developer.apple.com/documentation/appkit/nsevent)ï¼Œè€Œå¯ä»¥é€šè¿‡ [`clickCount`](https://developer.apple.com/documentation/appkit/nsevent/1528200-clickcount) åˆ¤æ–­å•å‡»è¿˜æ˜¯åŒå‡»ï¼ˆç»“å°¾æ²¡æœ‰å†’å· `:`ï¼‰
  - æœ‰æ— ç»“å°¾çš„å†’å· `:` ä¼šè¢«è®¤ä¸ºæ˜¯ **ä¸¤ä¸ªä¸åŒçš„ç¬¦å·**ï¼ˆä¸‹æ–­ç‚¹çš„æ—¶å€™éœ€è¦æ³¨æ„ ğŸ˜¶ï¼‰
- [æ ¹æ®çª—å£ç›¸å…³çš„æ–‡æ¡£](https://developer.apple.com/documentation/appkit/nswindow)ï¼Œæˆ‘ä»¬çŸ¥é“ï¼š
  - Cocoa ç¨‹åºçš„çª—å£æ˜¯ [`NSWindow`](https://developer.apple.com/documentation/appkit/nswindow) ç±»
  - çª—å£æœ€å¤§åŒ– éœ€è¦è°ƒç”¨ [`performZoom:`](https://developer.apple.com/documentation/appkit/nswindow/1419450-performzoom) æ–¹æ³•
  - çª—å£å…¨å± åˆ™æ˜¯è°ƒç”¨ [`toggleFullScreen:`](https://developer.apple.com/documentation/appkit/nswindow/1419527-togglefullscreen) æ–¹æ³•
  - å…¨å±å’Œæœ€å¤§åŒ–æ˜¯ **ä¸¤ä¸ªä¸åŒçš„æ“ä½œ**ï¼ˆç›®å‰ç”¨çš„è¿˜ä¸å¤ªä¹ æƒ¯ ğŸ˜¶ï¼‰

> ğŸ’¡ ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå¯ä»¥é…ç½® `.lldbinit`/`.gdbinit` æ–‡ä»¶ï¼ŒåŠ è½½ä¸ªäººä¹ æƒ¯çš„é…ç½®ã€‚

ä½¿ç”¨ lldb çš„ **é™„åŠ è¿›ç¨‹** åŠŸèƒ½ï¼ŒæŒ‚è½½ QQ è¿›ç¨‹ä¸Šï¼ˆå¦å¤–ï¼Œä¸ªäººä¹ æƒ¯æŠŠæ±‡ç¼–æŒ‡ä»¤è®¾ç½®ä¸º Intel é£æ ¼ ğŸ˜¶ï¼‰ï¼š

```
lldb --attach-name QQ
(lldb) settings set target.x86-disassembly-flavor intel
```

> ğŸ’¡ å¦‚æœä¸€å¼€å§‹æ²¡æœ‰æ€è·¯ï¼Œå¯ä»¥ä» **ç‰¹æ®Šå‡½æ•°çš„è°ƒç”¨** å°è¯•åˆ‡å…¥ â€”â€” ä¸€èˆ¬çš„ç³»ç»Ÿå‡½æ•°ã€åº“æ¥å£éƒ½æ˜¯ **å¯¼å‡ºå‡½æ•°**ï¼Œå¯ä»¥ç›´æ¥æœåˆ° â€”â€” æ‰€ä»¥èƒŒæ™¯è°ƒç ”çš„æ—¶å€™ï¼Œå°½é‡æŸ¥è¯¢è‹±æ–‡èµ„æ–™ã€‚

é¦–å…ˆï¼Œé€šè¿‡ **æœç´¢ç¬¦å·** `performZoom:`ï¼Œæ‰¾åˆ°å‡½æ•°çš„å…¥å£ï¼š

```
(lldb) im lookup -r -n 'performZoom'
2 matches found in /System/Library/Frameworks/AppKit.framework/Versions/C/AppKit:
        Address: AppKit[0x00007fff22f53cc9] (AppKit.__TEXT.__text + 3586761)
        Summary: AppKit`-[NSWindow performZoom:]
        Address: AppKit[0x00007fff231caccf] (AppKit.__TEXT.__text + 6171343)
        Summary: AppKit`-[NSDrawerWindow performZoom:]
```

éå¸¸å¹¸è¿ï¼Œæ‰¾åˆ°å•¦ï½ è€Œä¸”åªæœ‰ä¸¤ä¸ªç»“æœã€‚

> ğŸ’¡ é€šè¿‡ **è®¾ç½®æ–­ç‚¹+åå¤æ“ä½œ**ï¼Œå°è¯•å®šä½åˆ‡å…¥ç‚¹ã€‚å¦‚æœç»“æœéƒ½ä¸åŒ¹é…ï¼Œå¯ä»¥æœç´¢å…¶ä»–ç¬¦å·ï¼ˆæ¯”å¦‚ `DoubleClick`/`Titlebar`ï¼‰ï¼Œå¹¶å¤šè®¾ç½®ä¸€äº›æ–­ç‚¹ã€‚å¦‚æœè¿˜æ˜¯ä¸åŒ¹é…ï¼Œå¯ä»¥å†æŸ¥æŸ¥èµ„æ–™ï¼Œå¯»æ‰¾æ–°çš„å…³é”®è¯ã€‚

æ¥ç€ï¼Œå…ˆåœ¨å¯èƒ½æ€§æœ€å¤§çš„ `-[NSWindow performZoom:]` **è®¾ç½®æ–­ç‚¹**ï¼š

```
(lldb) b AppKit`-[NSWindow performZoom:]
Breakpoint 1: where = AppKit`-[NSWindow performZoom:], address = 0x00007fff22fb8cc9
```

è¿™æ—¶å€™ï¼Œå°è¯• **åŒå‡»æ ‡é¢˜æ ä¸ŠåŠéƒ¨åˆ†**ï¼Œéå¸¸å¹¸è¿ï¼Œå‘ç°æ¯æ¬¡çª—å£æ”¾ç¼©æ—¶ï¼Œéƒ½ä¼š **ç»è¿‡è¿™ä¸ªå‡½æ•°**ï¼š

```
Process 46732 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
    frame #0: 0x00007fff22fb8cc9 AppKit`-[NSWindow performZoom:]
AppKit`-[NSWindow performZoom:]:
->  0x7fff22fb8cc9 <+0>: push   rbp
    0x7fff22fb8cca <+1>: mov    rbp, rsp
    0x7fff22fb8ccd <+4>: push   r14
    0x7fff22fb8ccf <+6>: push   rbx
Target 0: (QQ) stopped.
```

å†å°è¯• **åŒå‡»æ ‡é¢˜æ ä¸‹åŠéƒ¨åˆ†**ï¼Œå¦‚æˆ‘æ‰€æ–™ï¼Œå‘ç°çª—å£ä¸ä¼šè¿›å…¥æ”¾ç¼©é€»è¾‘ï¼Œä¹Ÿ **ä¸ç»è¿‡è¿™ä¸ªå‡½æ•°**ã€‚å¦å¤–ï¼Œ**è¿›å…¥ã€é€€å‡ºå…¨å±æ¨¡å¼** ä¹Ÿä¸ä¼šè¿›å…¥è¿™ä¸ªå‡½æ•°ã€‚

> ğŸ’¡ æ‰¾åˆ°åˆ‡å…¥ç‚¹åï¼Œæ ¹æ® **è°ƒç”¨å…³ç³»**ï¼Œå¯»æ‰¾ **å¯ç–‘å‡½æ•°**ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ˜æ˜¾ç‰¹å¾ï¼Œå¯ä»¥è§‚å¯Ÿå‡½æ•° åœ¨ä¸åŒæ“ä½œä¸‹çš„è°ƒç”¨å…³ç³»ï¼Œå¯»æ‰¾ **è°ƒç”¨æ ˆçš„å…±åŒéƒ¨åˆ†**ã€‚

æ¥ç€ï¼Œé€šè¿‡ **æŸ¥çœ‹è°ƒç”¨æ ˆ**ï¼Œå‘ç° `AppKit` çš„ç¬¦å·éƒ½å¾ˆå…¨ï¼Œè€Œä¸”å‡½æ•°å‡ ä¹éƒ½èƒ½é¡¾åæ€ä¹‰ ğŸ‘ã€‚è¿™é‡Œçœ‹èµ·æ¥æ˜¯ `NSThemeFrame` å¤„ç†äº† `mouseUp:` äº‹ä»¶ï¼š

```
(lldb) bt
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 4.1
  * frame #0: 0x00007fff22fb8cc9 AppKit`-[NSWindow performZoom:]
    frame #1: 0x00007fff22f1e4b0 AppKit`-[NSTitledFrame _handlePossibleDoubleClickForEvent:] + 216
    frame #2: 0x00007fff22f1df5c AppKit`-[NSThemeFrame mouseUp:] + 278
    ...
```

è¿˜å¯ä»¥æ³¨æ„åˆ° `_handlePossibleDoubleClickForEvent:` åŒ…å«äº†å…³é”®è¯ `DoubleClick`ï¼Œçœ‹ä¼¼ç”¨äºæ§åˆ¶ â€œåŒå‡»æ ‡é¢˜æ  æ”¾ç¼©çª—å£â€ çš„å¤„ç†é€»è¾‘ã€‚

> ğŸ’¡ åå¤ **åˆ‡æ¢æ ˆå¸§**ï¼Œç»“åˆ **åæ±‡ç¼–** ç»“æœï¼Œæ¨æ–­å‡½æ•°çš„ **è°ƒç”¨é€»è¾‘å’Œå…³ç³»**ï¼ŒçŒœæµ‹å‡½æ•°çš„ **æ‰§è¡Œæµç¨‹å’Œæ„å›¾**ã€‚ï¼ˆå½“ç„¶ï¼Œå¦‚æœèƒ½æ‹¿åˆ°ç¬¦å·ï¼Œä¸€å®šè¦å…ˆ **åŠ è½½ç¬¦å·**ï¼›å¦‚æœèƒ½æ‹¿åˆ°æºç ï¼Œä¸€å®šè¦ **é…ç½®æºç è·¯å¾„** â€”â€” ä¸å¿…ç¡¬ç€å¤´çš® è¯»æ±‡ç¼–ä»£ç  ğŸ™ƒï¼‰

äºæ˜¯ï¼Œå…ˆ **åˆ‡æ¢æ ˆå¸§**ï¼Œå† **æŸ¥çœ‹åæ±‡ç¼–**ï¼š

<p><details>
<summary> ğŸ‘‰ ä»£ç æœ‰ç‚¹é•¿ï¼ˆæ…ç‚¹ ğŸ˜‘ï¼‰ğŸ‘ˆ </summary>
<pre><code>
(lldb) up
frame #1: 0x00007fff22f1e4b0 AppKit`-[NSTitledFrame _handlePossibleDoubleClickForEvent:] + 216
AppKit`-[NSTitledFrame _handlePossibleDoubleClickForEvent:]:
->  0x7fff22f1e4b0 <+216>: mov    al, 0x1
    0x7fff22f1e4b2 <+218>: jmp    0x7fff22f1e44c            ; <+116>
(lldb) d
AppKit`-[NSTitledFrame _handlePossibleDoubleClickForEvent:]:
    0x7fff22f1e3d8 <+0>:   push   rbp
    0x7fff22f1e3d9 <+1>:   mov    rbp, rsp
    0x7fff22f1e3dc <+4>:   push   r15
    0x7fff22f1e3de <+6>:   push   r14
    0x7fff22f1e3e0 <+8>:   push   rbx
    0x7fff22f1e3e1 <+9>:   push   rax
    0x7fff22f1e3e2 <+10>:  mov    rbx, rdx
    0x7fff22f1e3e5 <+13>:  mov    r14, rdi
    0x7fff22f1e3e8 <+16>:  mov    rsi, qword ptr [rip + 0x65b8a1f1] ; "clickCount"
    0x7fff22f1e3ef <+23>:  mov    rdi, rdx
    0x7fff22f1e3f2 <+26>:  call   qword ptr [rip + 0x5d65c5f8] ; (void *)0x00007fff20211d00: objc_msgSend
    0x7fff22f1e3f8 <+32>:  cmp    rax, 0x2
    0x7fff22f1e3fc <+36>:  jne    0x7fff22f1e44a            ; <+114>
    0x7fff22f1e3fe <+38>:  mov    rsi, qword ptr [rip + 0x65ba89d3] ; "_eventInTitlebar:"
    0x7fff22f1e405 <+45>:  mov    rdi, r14
    0x7fff22f1e408 <+48>:  mov    rdx, rbx
    0x7fff22f1e40b <+51>:  call   qword ptr [rip + 0x5d65c5df] ; (void *)0x00007fff20211d00: objc_msgSend
    0x7fff22f1e411 <+57>:  test   al, al
    0x7fff22f1e413 <+59>:  je     0x7fff22f1e44a            ; <+114>
    0x7fff22f1e415 <+61>:  mov    rsi, qword ptr [rip + 0x65b840ac] ; "modifierFlags"
    0x7fff22f1e41c <+68>:  mov    rdi, rbx
    0x7fff22f1e41f <+71>:  call   qword ptr [rip + 0x5d65c5cb] ; (void *)0x00007fff20211d00: objc_msgSend
    0x7fff22f1e425 <+77>:  bt     eax, 0x12
    0x7fff22f1e429 <+81>:  jb     0x7fff22f1e44a            ; <+114>
    0x7fff22f1e42b <+83>:  lea    rax, [rip + 0x65bccd4e]   ; NSView._window
    0x7fff22f1e432 <+90>:  mov    r15, qword ptr [rax]
    0x7fff22f1e435 <+93>:  mov    rdi, qword ptr [r14 + r15]
    0x7fff22f1e439 <+97>:  mov    rsi, qword ptr [rip + 0x65b840f8] ; "_isInHiddenWindowTab"
    0x7fff22f1e440 <+104>: call   qword ptr [rip + 0x5d65c5aa] ; (void *)0x00007fff20211d00: objc_msgSend
    0x7fff22f1e446 <+110>: test   al, al
    0x7fff22f1e448 <+112>: je     0x7fff22f1e45a            ; <+130>
    0x7fff22f1e44a <+114>: xor    eax, eax
    0x7fff22f1e44c <+116>: movzx  eax, al
    0x7fff22f1e44f <+119>: add    rsp, 0x8
    0x7fff22f1e453 <+123>: pop    rbx
    0x7fff22f1e454 <+124>: pop    r14
    0x7fff22f1e456 <+126>: pop    r15
    0x7fff22f1e458 <+128>: pop    rbp
    0x7fff22f1e459 <+129>: ret    
    0x7fff22f1e45a <+130>: mov    rdi, qword ptr [r14 + r15]
    0x7fff22f1e45e <+134>: call   0x7fff237e1b4c            ; symbol stub for: objc_opt_class
    0x7fff22f1e463 <+139>: mov    rsi, qword ptr [rip + 0x65ba8976] ; "_shouldZoomOnDoubleClick"
    0x7fff22f1e46a <+146>: mov    rdi, rax
    0x7fff22f1e46d <+149>: call   qword ptr [rip + 0x5d65c57d] ; (void *)0x00007fff20211d00: objc_msgSend
    0x7fff22f1e473 <+155>: test   al, al
    0x7fff22f1e475 <+157>: je     0x7fff22f1e480            ; <+168>
    0x7fff22f1e477 <+159>: mov    rsi, qword ptr [rip + 0x65ba896a] ; "_zoomWindowWithDoubleClick:"
    0x7fff22f1e47e <+166>: jmp    0x7fff22f1e4a4            ; <+204>
    0x7fff22f1e480 <+168>: mov    rdi, qword ptr [r14 + r15]
    0x7fff22f1e484 <+172>: call   0x7fff237e1b4c            ; symbol stub for: objc_opt_class
    0x7fff22f1e489 <+177>: mov    rsi, qword ptr [rip + 0x65ba8960] ; "_shouldMiniaturizeOnDoubleClick"
    0x7fff22f1e490 <+184>: mov    rdi, rax
    0x7fff22f1e493 <+187>: call   qword ptr [rip + 0x5d65c557] ; (void *)0x00007fff20211d00: objc_msgSend
    0x7fff22f1e499 <+193>: test   al, al
    0x7fff22f1e49b <+195>: je     0x7fff22f1e44a            ; <+114>
    0x7fff22f1e49d <+197>: mov    rsi, qword ptr [rip + 0x65ba8954] ; "_minimizeWindowWithDoubleClick:"
    0x7fff22f1e4a4 <+204>: mov    rdi, r14
    0x7fff22f1e4a7 <+207>: mov    rdx, rbx
    0x7fff22f1e4aa <+210>: call   qword ptr [rip + 0x5d65c540] ; (void *)0x00007fff20211d00: objc_msgSend
->  0x7fff22f1e4b0 <+216>: mov    al, 0x1
    0x7fff22f1e4b2 <+218>: jmp    0x7fff22f1e44c            ; <+116>
</code></pre>
</details></p>

æ ¹æ®åæ±‡ç¼–çŸ¥è¯†ï¼ŒçŒœæƒ³ï¼š

- `objc_msgSend` ç”¨äºè°ƒç”¨ Objective-C å¯¹è±¡æ–¹æ³•
  - æ–¹æ³•åé€šè¿‡ `$rsi` ä¼ é€’
  - å¯¹è±¡æŒ‡é’ˆé€šè¿‡ `$rdi` ä¼ é€’
- `_handlePossibleDoubleClickForEvent:` çš„å‰åŠéƒ¨åˆ†åˆ¤æ–­
  - `(NSEvent*)event.clickCount == 2`
  - `[self _eventInTitlebar:event] == YES`
  - `(NSEvent*)event.modifierFlags & 0x12`
  - `[self._window _isInHiddenWindowTab] == NO`
  - å¦‚æœä¸æ»¡è¶³ä¸Šè¿° 4 ä¸ªæ¡ä»¶ï¼Œç›´æ¥ `jmp 0x7fff22f1e44a`ï¼Œè·³è¿‡åç»­é€»è¾‘
  - åªæœ‰æ»¡è¶³äº†ä¸Šè¿° 4 ä¸ªæ¡ä»¶ï¼Œæ‰èƒ½ `jmp 0x7fff22f1e45a`ï¼Œè¿›å…¥åç»­é€»è¾‘
- `_handlePossibleDoubleClickForEvent:` çš„ååŠéƒ¨åˆ†ï¼Œæ ¹æ®ç³»ç»Ÿè®¾ç½®ï¼Œé€‰æ‹© **æ”¾ç¼©çª—å£** æˆ– **æœ€å°åŒ–çª—å£**ï¼ˆå†æ¬¡ [å‚è€ƒç½‘å‹çš„å›ç­”](https://apple.stackexchange.com/questions/95681/how-can-i-change-os-x-double-click-on-title-bar-to-be-like-windows/232153#232153)ï¼‰
  - **æ—§ç‰ˆ macOS ç³»ç»Ÿ** åŒå‡»æ ‡é¢˜æ çš„äº¤äº’é€»è¾‘æ˜¯ **æœ€å°åŒ–çª—å£**ï¼ˆè®© Windows ç”¨æˆ·æŠ“ç‹‚ ğŸ˜«ï¼‰
  - **æ–°ç‰ˆ macOS ç³»ç»Ÿ** æ”¯æŒä¸Šè¿°ä¸¤ç§è¡Œä¸ºï¼ˆé»˜è®¤æ˜¯ **æ”¾ç¼©çª—å£**ï¼‰

å¤§å®¶å¯èƒ½ä¼šé—®ï¼šè°ƒç”¨æ ˆä¸Šä¸ºä»€ä¹ˆæ²¡æœ‰å‡ºç° `_zoomWindowWithDoubleClick:`ï¼Ÿçœ‹ä¸Šå»æ˜¯ç›´æ¥è°ƒç”¨äº† `performZoom:` å‡½æ•°ã€‚è¿™æ˜¯å› ä¸ºï¼š

- `_zoomWindowWithDoubleClick:` å†…éƒ¨ä½¿ç”¨äº† **æ ˆå¸§æŒ‡é’ˆçœç•¥** _(frame pointer omission, FPO)_ ä¼˜åŒ–
- ç›´æ¥ç”¨ `jmp` æŒ‡ä»¤ä»£æ›¿ `call` æŒ‡ä»¤è°ƒç”¨ `performZoom:` å‡½æ•°ï¼Œä¸ä¼šæ„é€ æ–°çš„æ ˆå¸§

> ğŸ’¡ é€šè¿‡ **å•æ­¥è°ƒè¯•** è·Ÿè¸ªè°ƒç”¨æµç¨‹ï¼Œæ‰¾åˆ°å‡ºç° **æ‰§è¡Œè·¯å¾„åˆ†æ­§** çš„ä½ç½®ã€‚è¿˜å¯ä»¥ **å•æ­¥è¿›å…¥å‡½æ•°**ï¼Œè·Ÿè¸ªå­å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œåˆ†æå‡ºç° **åˆ†æ­§çš„åŸå› **ã€‚

ä¸ºäº†éªŒè¯çŒœæƒ³ï¼Œå¯ä»¥å†æ¬¡ **è®¾ç½®æ–­ç‚¹**ï¼š

```
(lldb) b AppKit`-[NSTitledFrame _handlePossibleDoubleClickForEvent:]
Breakpoint 2: where = AppKit`-[NSTitledFrame _handlePossibleDoubleClickForEvent:], address = 0x00007fff22f1e3d8
```

ç„¶åï¼Œå°è¯• **ç‚¹å‡»æ ‡é¢˜æ ä»»æ„éƒ¨åˆ†**ï¼ˆåŒ…æ‹¬å•å‡»ã€åŒå‡»ï¼‰ï¼Œéå¸¸å¹¸è¿ï¼Œå‘ç°æ— è®ºçª—å£æ˜¯å¦æ”¾ç¼©ï¼Œéƒ½ä¼š **ç»è¿‡è¿™ä¸ªå‡½æ•°**ã€‚å¦å¤–ï¼Œç‚¹å‡»ç•Œé¢ä¸Šçš„å…¶ä»–åŒºåŸŸï¼Œä¸ä¼šè¿›å…¥è¿™ä¸ªå‡½æ•°ã€‚

æ¥ç€ï¼Œåˆ©ç”¨ **å•æ­¥è°ƒè¯•**ï¼Œå¯ä»¥å‘ç°ï¼šåœ¨åŒå‡»ï¼ˆå³ `event.clickCount == 2`ï¼‰çš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨ `_eventInTitlebar:` åï¼Œåœ¨ `0x7fff22f1e411` æ£€æŸ¥è¿”å›å€¼ `$al`ï¼Œå‡ºç°äº†åˆ†æ­§ï¼š

- åŒå‡»æ ‡é¢˜æ ä¸ŠåŠéƒ¨åˆ†ï¼Œ`$al` ä¸º `0x01`ï¼Œè¿›å…¥æ”¾ç¼©é€»è¾‘
- åŒå‡»æ ‡é¢˜æ ä¸‹åŠéƒ¨åˆ†ï¼Œ`$al` ä¸º `0x00`ï¼Œè·³è¿‡æ”¾ç¼©é€»è¾‘

> ğŸ’¡ åˆ©ç”¨ **æ–­ç‚¹å‘½ä»¤** è¾“å‡ºæ—¥å¿—ã€éä¾µå…¥å¼çš„ä¿®æ”¹è¿è¡ŒçŠ¶æ€ï¼Œå†ç»“åˆ **åå¤æ“ä½œ**ï¼Œè§‚å¯ŸçŠ¶æ€å˜åŒ–çš„å¼‚åŒç‚¹ï¼Œ**éªŒè¯** ä¹‹å‰çš„çŒœæƒ³ã€‚

ä¸ºäº†è¿›ä¸€æ­¥éªŒè¯çŒœæƒ³ï¼Œä½¿ç”¨ **æ–­ç‚¹å‘½ä»¤** æ‰“å° `_eventInTitlebar:` çš„è¿”å›å€¼ `$al`ï¼Œå¹¶ç«‹å³ **ç»§ç»­æ‰§è¡Œ**ï¼š

```
(lldb) br disable 1 2
2 breakpoints disabled.
(lldb) b 0x7fff22f1e411
Breakpoint 3: where = AppKit`-[NSTitledFrame _handlePossibleDoubleClickForEvent:] + 57, address = 0x00007fff22f1e411
(lldb) br command add 3
Enter your debugger command(s).  Type 'DONE' to end.
> re r al 
> c 
> DONE
```

ç»è¿‡åå¤è§‚å¯Ÿï¼Œå¯ä»¥å‘ç°ï¼šåœ¨åŒå‡»æ ‡é¢˜æ çš„ä¸ŠåŠéƒ¨åˆ†å’Œä¸‹åŠéƒ¨åˆ†æ—¶ï¼Œ`_eventInTitlebar:` åˆ†åˆ«è¿”å› `0x01` å’Œ `0x00`ï¼Œç¬¦åˆé¢„æœŸã€‚

æœ€åï¼Œå¯ä»¥é‡æ–°è®¾ç½® **æ–­ç‚¹å‘½ä»¤**ï¼Œè®© `_eventInTitlebar:` æ€»æ˜¯è¿”å› `0x01`ï¼Œè¿™æ ·å°± **ä¸´æ—¶è§£å†³** äº†è¿™ä¸ªçƒ¦äººçš„é—®é¢˜ï¼š

```
(lldb) br command add 3
Enter your debugger command(s).  Type 'DONE' to end.
> re w al 0x01 
> c 
> DONE
```

ç”±äºè¿›ç¨‹ä½¿ç”¨äº† **åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–** _(address space layout randomization, ASLR)_ï¼ŒåŒä¸€æ¨¡å—é‡Œçš„åŒä¸€æŒ‡ä»¤ åœ¨å†…å­˜ä¸­çš„ **å®é™…åœ°å€**ï¼ˆä¾‹å¦‚è¿™æ¬¡æ˜¯ `0x7fff22f1e411`ï¼‰åœ¨ä¸åŒè¿›ç¨‹ä¸­ **å¯èƒ½ä¸åŒ**ï¼ˆæ¯æ¬¡è¿è¡Œéƒ½æ˜¯ä¸åŒè¿›ç¨‹ï¼‰ï¼Œä½†ç›¸å¯¹äºå‡½æ•°çš„ **åç§»é‡æ˜¯ä¸å˜çš„**ï¼ˆä¾‹å¦‚æ­¤å¤„æ˜¯ `+ 57`ï¼‰ã€‚

æ‰€ä»¥ï¼Œé’ˆå¯¹åŒå‡»æ ‡é¢˜æ æ— æ³•æ”¾ç¼©çš„é—®é¢˜ï¼Œä¸è®ºæ˜¯ QQ è¿˜æ˜¯å…¶ä»–è½¯ä»¶ï¼Œéƒ½å¯ä»¥ â€œå€ŸåŠ© **æŒ‡ä»¤åç§»é‡** è®¾ç½®æ–­ç‚¹ã€æ·»åŠ  **æ–­ç‚¹å‘½ä»¤**ã€å† **ç»§ç»­æ‰§è¡Œ**â€ çš„æ–¹æ³•è§£å†³ï¼š

```
(lldb) br set -n '-[NSTitledFrame _handlePossibleDoubleClickForEvent:]' -R 57 -C 're w al 0x01' -G true
```

> ğŸ‘€ ç»™å¤§å®¶ç•™ä¸ªæ€è€ƒé¢˜ â€”â€”

å¦‚ä½• **å½»åº•è§£å†³** è¿™ä¸ªé—®é¢˜ï¼Ÿéš¾ç‚¹åœ¨äºï¼š

- ç”±äº `_handlePossibleDoubleClickForEvent:` å’Œ `_eventInTitlebar:` æ˜¯ `AppKit` é‡Œçš„ç¬¦å·ï¼Œæ”¾åœ¨ç³»ç»Ÿç›®å½•ï¼Œä¸èƒ½ç›´æ¥ä¿®æ”¹é‡Œè¾¹çš„ä»£ç ï¼ˆå³ä½¿ä¿®æ”¹äº†ï¼Œä¹Ÿä¼šå¸¦æ¥å…¶ä»–é£é™©ï¼‰
- æ‰€ä»¥ï¼Œæˆ‘ä»¬åªèƒ½ä¿®æ”¹è½¯ä»¶æœ¬èº«çš„ä»£ç ï¼›ä½†è¿™äº›ä»£ç æ²¡æœ‰ç¬¦å·ï¼ˆå½“ç„¶ä¸ä¼šå…¬å¼€ï¼‰ï¼Œéš¾ä»¥å®šä½åˆ‡å…¥ç‚¹
- å¦‚æœä½ æœ‰æƒ³æ³•ï¼Œ**æ¬¢è¿åœ¨æ–‡ç« ä¸‹æ–¹ç•™è¨€**ï¼ˆæŠ“ç´§æ—¶é—´ï¼Œè¯´ä¸å®š[ä¸‹ä¸€ä¸ªç‰ˆæœ¬ QQ](https://im.qq.com/macqq/) å°±ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ ğŸ™ƒï¼‰

## å†…å­˜ç ´åçš„ä¾¦æ¢æ¸¸æˆ

> ğŸ’¡ ç”±äºèƒ½æ‹¿åˆ°è¢«è°ƒè¯•å¯¹è±¡çš„ ç¬¦å·å’Œæºç ï¼Œå¯ä»¥å€ŸåŠ©è°ƒè¯•æŠ€å·§ï¼Œå¿«é€Ÿå®šä½é—®é¢˜ã€‚

### å¤©æ—¶åœ°åˆ©äººå’Œ

æœ€è¿‘ï¼Œæˆ‘ **é¢‘ç¹é‡åˆ°** ä¸€ä¸ªéå¸¸è¯¡å¼‚çš„ **å†…å­˜ç ´åå´©æºƒ** ğŸ˜ˆ â€”â€”

- è™½ç„¶å½±å“èŒƒå›´è¾ƒå°ï¼šåªä¼šåœ¨ç¨‹åºé€€å‡ºæ—¶å´©æºƒï¼Œå¹¶ä¸å½±å“å…¶ä»–åŠŸèƒ½çš„æ­£å¸¸ä½¿ç”¨
- ä½†ä¸¥é‡å½±å“äº†ç”¨æˆ·ä½“éªŒï¼šæ¯æ¬¡åœ¨ç¨‹åºé€€å‡ºæ—¶ï¼Œæ€»èƒ½çœ‹åˆ°ä¸€ä¸ªå¼¹å‡ºçš„å´©æºƒæç¤º

ğŸ•µï¸ ç”±äºå½“æ—¶ ç¢°å·§å¤ç°äº†è¿™ä¸ª â€œåªæœ‰å°‘æ•°ç”¨æˆ· å¶å°”é‡åˆ°â€ çš„å´©æºƒï¼Œäºæ˜¯ æˆ‘å¼€å§‹å¯»æ‰¾ â€œå¹•åé»‘æ‰‹â€ã€‚

æœ¬æ–‡å°†å´©æºƒä»£ç çš„æ ¸å¿ƒé€»è¾‘è®°å½•åœ¨ [`insane_iterator.cc`](Debug-Everywhere/insane_iterator.cc) é‡Œï¼Œå¯ä»¥ä½¿ç”¨ clang 12 ç¼–è¯‘ï¼Œå†é€šè¿‡ lldb è¿è¡Œåï¼Œçœ‹åˆ°å´©æºƒï¼š

```
clang++ -std=c++17 -g insane_iterator.cc && lldb ./a.out
```

### ç¬¬ä¸€æ‹›ï¼šå·¥å…·æ£€æŸ¥

ä¼—æ‰€å‘¨çŸ¥ï¼Œ**å†…å­˜ç ´å** æ˜¯ä¸€ç§æ£˜æ‰‹çš„å´©æºƒç±»å‹ï¼š

- ç”±äºç¨‹åºå‡ºç° **é€»è¾‘é”™è¯¯**ï¼Œåœ¨æŸæ¬¡ä¿®æ”¹å†…å­˜æ—¶ï¼Œâ€œä¸å°å¿ƒâ€ **ç¯¡æ”¹äº†å…¶ä»–ä½ç½®çš„å†…å­˜**
- ä¸€èˆ¬ **ä¸ä¼šç«‹å³å´©æºƒ**ï¼Œè€Œåªæœ‰åœ¨ä½¿ç”¨ â€œè¢«ç¯¡æ”¹â€ çš„å†…å­˜æ—¶ï¼Œæ‰ä¼šå‡ºç° **å†…å­˜è®¿é—®é”™è¯¯**
- è€Œåœ¨å´©æºƒå‡ºç°æ—¶ï¼Œ**ä¸ºæ—¶å·²æ™š**ï¼Œ**éš¾ä»¥åæ¨** æœ€åˆçš„å†…å­˜ç ´å åœ¨ä½•å¤„

ç±»ä¼¼äºï¼ŒæŠŠå¥³æœ‹å‹æ–°ä¹°çš„è£™å­ ğŸ‘— å½“ä½œæŠ¹å¸ƒæ“¦æ¡Œå­åï¼Œå†å°å¿ƒç¿¼ç¿¼çš„æ”¾å›å»ï¼Œå¥³æœ‹å‹ ğŸ‘© å¹¶ä¸ä¼šç«‹å³å‘ç°ï¼š

- åªæœ‰å¥¹ä¸‹æ¬¡å‡†å¤‡ç©¿è¿™æ¡è£™å­ ğŸ’ƒ æ—¶ï¼Œæ‰ä¼šå‘ç°ï¼ˆå‡ºç°å´©æºƒï¼‰
- å¦‚æœå¥¹çš„è£™å­å¤ªå¤šï¼Œè¿™æ¡è£™å­è¢«å‹åœ¨æŸœå­çš„æœ€ä¸‹è¾¹ï¼Œé‚£ä¹ˆå¥¹æ°¸è¿œä¹Ÿä¸ä¼šå‘ç° ğŸ˜‚ï¼ˆä¸ä¼šå´©æºƒï¼‰
- å³ä½¿å¥¹å‘ç°äº†ï¼Œä¹Ÿä¸ä¼šçŸ¥é“ å¯æ€œçš„è£™å­ç»å†äº†ä»€ä¹ˆ ğŸ™ˆï¼ˆæ— æ³•å›æº¯ï¼‰

> ğŸ’¡ [AddressSanitizer](https://github.com/google/sanitizers/wiki/AddressSanitizer) _(ASan)_ å·¥å…·å¸¸ç”¨äº å®šä½å†…å­˜ç ´åçš„æ—¶æœºï¼Œæ”¯æŒæ£€æµ‹ é‡Šæ”¾åä½¿ç”¨ï¼ˆæ‚¬å‚å¼•ç”¨ï¼‰ã€ç¼“å†²åŒºæº¢å‡ºã€åˆå§‹åŒ–é¡ºåºé”™è¯¯ã€å†…å­˜æ³„éœ² ç­‰é—®é¢˜ã€‚
> 
> ä¾‹å¦‚ï¼Œå¸¸è§çš„ `std::map` å¯¹è±¡æ•°æ®æŸåé—®é¢˜ï¼Œä¸€èˆ¬å¾ˆéš¾ç›´æ¥ä» **è°ƒç”¨æ ˆ** æ‰¾åˆ°æ•°æ®æŸåçš„åŸå› ï¼š
> 
> ![Map-Crash-Stack](Debug-Everywhere/Map-Crash-Stack.png)
> 
> ä½†æ˜¯ï¼Œå¯ä»¥å€ŸåŠ© ASan å·¥å…·ï¼Œåœ¨å‡ºç°å†…å­˜ç ´åæ—¶ï¼Œ**ç«‹å³å´©æºƒ**ï¼Œåœæ­¢è¿è¡Œï¼ˆå› ä¸ºç»§ç»­è¿è¡Œä¸€èˆ¬æ²¡æœ‰æ„ä¹‰äº†ï¼‰ï¼Œå¹¶æ‰“å° **å½“å‰è°ƒç”¨æ ˆ**ã€**è¢«ç ´åå†…å­˜çš„ä½ç½®**ï¼ˆå¦‚æœå†…å­˜å·²ä½¿ç”¨ï¼Œè¿˜ä¼šæ‰“å° **åˆ†é…è¯¥å†…å­˜æ—¶çš„è°ƒç”¨æ ˆ**ï¼‰ï¼Œä»è€Œæå‰æš´éœ²é”™è¯¯ï¼š
> 
> ![Map-Crash-Asan](Debug-Everywhere/Map-Crash-Asan.png)

æ‹¿åˆ°è¿™ä¸ªé—®é¢˜åï¼Œå¯ä»¥å…ˆå°è¯•ä½¿ç”¨ ASan **å·¥å…·æ£€æŸ¥**ï¼Œé‡æ–°ç¼–è¯‘ã€è¿è¡Œï¼Œå¯»æ‰¾å†…å­˜ç ´åçš„æ—¶æœºï¼š

```
clang++ -std=c++17 -g -fsanitize=address insane_iterator.cc && ./a.out
```

ç„¶è€Œï¼Œ**å‡ºå¸ˆä¸åˆ©**ï¼ˆåœ¨æˆ‘çš„ MacBook Pro ä¸Šï¼‰â€”â€”

- ä¸€æ—¦åŠ ä¸Š `-fsanitize=address` å‚æ•°ç¼–è¯‘åï¼Œç¨‹åºç«Ÿç„¶æ¯æ¬¡éƒ½èƒ½æ­£å¸¸é€€å‡ºï¼Œä¸ä¼šå‡ºç°å´©æºƒ ğŸ™ˆ
- ä¸€æ—¦ä¸ç”¨ ASan ç¼–è¯‘ï¼Œæ€»èƒ½ â€œç¨³å®šå¤ç°â€ é€€å‡ºå´©æºƒçš„é—®é¢˜ ğŸ˜­

> å½“ç„¶ï¼Œ**ä¸åŒç³»ç»Ÿ** çš„è¿è¡Œç»“æœå¯èƒ½ä¸åŒï¼š
> 
> - Windows ä¸Š clang 11 æ— è®ºæ˜¯å¦ä½¿ç”¨ ASan ç¼–è¯‘ï¼Œæ€»æ˜¯ä¸ä¼šå´©æºƒï¼ˆéƒ½ä¸ç¬¦åˆé¢„æœŸï¼‰
> - Linux ä¸Š clang 11/13 æ— è®ºæ˜¯å¦ä½¿ç”¨ ASan ç¼–è¯‘ï¼Œéƒ½ä¼šå‡ºç°å´©æºƒï¼ˆ[ç¬¦åˆé¢„æœŸï¼Œå¹¶ä¸” ASan æŒ‡å‡ºäº†å†…å­˜ç ´åçš„ä½ç½®](https://godbolt.org/z/jYvWbMns4)ï¼‰

çŒœæƒ³åŸå› æ˜¯ï¼šåŸæœ¬å†…å­˜ç ´åçš„ä½ç½®ï¼Œåœ¨è¢« ASan éš”å¼€åï¼Œåˆšå¥½è½åœ¨åˆæ³•çš„å†…å­˜åŒºåŸŸå†…ï¼Œæ‰€ä»¥æ²¡æœ‰æŠ¥é”™ â€”â€” **æ­ªæ‰“æ­£ç€** ğŸ˜¶ã€‚

### ç¬¬äºŒæ‹›ï¼šä¸Šè°ƒè¯•å™¨

ğŸ•µï¸ ç¬¬ä¸€æ­¥ï¼Œæ ¹æ®å´©æºƒæ—¶çš„ â€œæ¡ˆå‘ç°åœºâ€ï¼Œåˆ†æå´©æºƒçš„ **ç›´æ¥åŸå› **ã€‚

æ ¹æ® **å´©æºƒä¿¡æ¯** å¾—çŸ¥ï¼Œè¿›ç¨‹åœ¨è¿è¡Œ `0x17758f25702` å‡½æ•°æ—¶ï¼Œå°è¯•è¯»å– `0x17758f25600` å†…å­˜ï¼Œå‡ºç° **å†…å­˜è®¿é—®é”™è¯¯**ï¼ˆæ¯æ¬¡è¿è¡Œæ—¶ï¼Œä¸ä¸€å®šæ˜¯ `0x17758f25600`ï¼‰ï¼š

```
Process 61235 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x17758f25702)
    frame #0: 0x0000017758f25702
error: memory read failed for 0x17758f25600
Target 0: (a.out) stopped.
```

é¦–å…ˆï¼Œé€šè¿‡ **æŸ¥çœ‹è°ƒç”¨æ ˆ**ï¼Œå¾ˆå®¹æ˜“å‘ç° `0x17758f25702` â€œçœ‹èµ·æ¥â€ ä¸åƒä¸€ä¸ªåˆæ³•çš„å‡½æ•°ï¼ˆå› ä¸ºåœ¨è°ƒç”¨æ ˆé‡Œï¼Œ`a.out` çš„å…¶ä»–å‡½æ•°éƒ½åœ¨ `0x000000010000????` èŒƒå›´å†…ï¼‰ï¼š

```
(lldb) bt
* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x17758f25702)
  * frame #0: 0x0000017758f25702
    frame #1: 0x0000000100008419 a.out`BindStateBase::~BindStateBase(this=0x0000000100304320) at insane_iterator.cc:26:22
    frame #2: 0x00000001000083f5 a.out`BindStateBase::~BindStateBase(this=0x0000000100304320) at insane_iterator.cc:26:20
    frame #3: 0x000000010000838b a.out`std::__1::default_delete<BindStateBase>::operator(this=0x00000001003040f8, __ptr=0x0000000100304320)(BindStateBase*) const at memory:2368:5
    frame #4: 0x0000000100008049 a.out`std::__1::__shared_ptr_pointer<BindStateBase*, std::__1::default_delete<BindStateBase>, std::__1::allocator<BindStateBase> >::__on_zero_shared(this=0x00000001003040e0) at memory:3541:5
    frame #5: 0x0000000100008b9d a.out`std::__1::__shared_count::__release_shared(this=0x00000001003040e0) at memory:3445:9
    frame #6: 0x0000000100008b3f a.out`std::__1::__shared_weak_count::__release_shared(this=0x00000001003040e0) at memory:3487:27
    frame #7: 0x0000000100008b0c a.out`std::__1::shared_ptr<BindStateBase>::~shared_ptr(this=0x00007ffeefbff608) at memory:4212:19
    frame #8: 0x0000000100008ad5 a.out`std::__1::shared_ptr<BindStateBase>::~shared_ptr(this=0x00007ffeefbff608) at memory:4210:1
    frame #9: 0x0000000100008ab5 a.out`CallbackBase::~CallbackBase(this=0x00007ffeefbff608) at insane_iterator.cc:69:7
    frame #10: 0x0000000100008a98 a.out`OnceCallback<void ()>::~OnceCallback(this=0x00007ffeefbff608) at insane_iterator.cc:88:7
    frame #11: 0x0000000100004815 a.out`OnceCallback<void ()>::~OnceCallback(this=0x00007ffeefbff608) at insane_iterator.cc:88:7
    frame #12: 0x000000010000ade1 a.out`OnceCallback<void ()>::Run(this=0x0000000101008200) && at insane_iterator.cc:112:3
    frame #13: 0x000000010000acfa a.out`AtExitManager::~AtExitManager(this=0x00007ffeefbff6c8) at insane_iterator.cc:230:31
    frame #14: 0x0000000100003d65 a.out`AtExitManager::~AtExitManager(this=0x00007ffeefbff6c8) at insane_iterator.cc:228:20
    frame #15: 0x0000000100003bf6 a.out`main at insane_iterator.cc:319:1
    frame #16: 0x00007fff203a7621 libdyld.dylib`start + 1
```

é€šè¿‡ **æŸ¥çœ‹åæ±‡ç¼–**ï¼Œè¿›ä¸€æ­¥ç¡®è®¤ `0x17758f25702` ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼š

```
(lldb) d -a 0x17758f25702
error: Could not find function bounds for address 0x17758f25702
```

ç„¶åï¼Œå…ˆ **åˆ‡æ¢æ ˆå¸§**ï¼Œå† **æŸ¥çœ‹å˜é‡**ï¼Œå¯ä»¥å‘ç° åœ¨æœ€åä¸€æ¬¡å‡½æ•°è°ƒç”¨æ—¶ï¼Œ`BindStateBase` å¯¹è±¡çš„ `destructor_` æˆå‘˜å˜é‡æ˜¯ä¸ªé”™è¯¯çš„ `0x17758f25702` å‡½æ•°æŒ‡é’ˆï¼ˆå…¶ä½™å­—æ®µ â€œçœ‹èµ·æ¥â€ æ˜¯æ­£ç¡®çš„ï¼‰ï¼š

```
(lldb) up
frame #1: 0x0000000100008419 a.out`BindStateBase::~BindStateBase(this=0x0000000100304320) at insane_iterator.cc:26:22
-> 26     ~BindStateBase() { destructor_(this); }
   27  
(lldb) v *this
(BindStateBase) *this = {
  padding_ = ""
  polymorphic_invoke_ = 0x0000000100007860 (a.out`Invoker<BindState<void (*)()>, void ()>::RunOnce(BindStateBase*) at insane_iterator.cc:181)
  destructor_ = 0x0000017758f25702 (0x0000017758f25702)
}
```

ç»“åˆç¨‹åºçš„ **æºç **ï¼Œæ ¹æ®å´©æºƒæ—¶çš„ **è°ƒç”¨æ ˆ**ï¼Œåˆ†æå´©æºƒçš„ç›´æ¥åŸå› ï¼šåœ¨ç¨‹åºé€€å‡ºæ—¶ï¼Œæ‰§è¡Œäº†ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼›åœ¨é”€æ¯å›è°ƒä»»åŠ¡å¯¹è±¡æ—¶ï¼Œç”±äºå¯¹è±¡å†…å­˜è¢«ç ´åï¼Œå¯¼è‡´å´©æºƒã€‚ï¼ˆä»¥ä¸‹åˆ†æ **ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹**ï¼Œå…·ä½“å®ç°å‚è€ƒ [Chromium ä»£ç ](https://github.com/chromium/chromium)ï¼‰

> - æ ˆåº•æ˜¯ [`AtExitManager`](https://github.com/chromium/chromium/blob/master/base/at_exit.h) çš„ææ„å‡½æ•°
>   - `AtExitManager` ç”¨äºåœ¨ `main()` å‡½æ•° **é€€å‡ºæ—¶**ï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°ï¼ˆä¾‹å¦‚ **é‡Šæ”¾èµ„æºã€ä¿å­˜ç¨‹åºçŠ¶æ€** ç­‰ï¼‰
> - å¾€ä¸Šæ˜¯ [`OnceCallback<>`](https://github.com/chromium/chromium/blob/master/base/callback.h) çš„ææ„å‡½æ•°
>   - `OnceCallback<>` æ˜¯ Chromium æä¾›çš„ä¸€ç§ **å›è°ƒå‡½æ•°**ï¼Œåªå…è®¸æ‰§è¡Œä¸€æ¬¡ï¼Œå¹¶åœ¨æ‰§è¡Œåç«‹å³é”€æ¯ï¼ˆå…·ä½“å‚è€ƒ [æ·±å…¥ C++ å›è°ƒ](../2019/Inside-Cpp-Callback.md) ğŸ‘ˆï¼‰
> - æ ˆé¡¶æ˜¯ [`BindStateBase`](https://github.com/chromium/chromium/blob/master/base/callback_internal.h) çš„ææ„å‡½æ•°
>   - `BindStateBase` ç”¨äºå­˜å‚¨é€šç”¨çš„ **å›è°ƒé—­åŒ…**ï¼ˆæ¥å£ï¼‰
>   - [`BindState<>`](https://github.com/chromium/chromium/blob/master/base/bind_internal.h) æ¨¡ç‰ˆç»§æ‰¿äº `BindStateBase`ï¼Œç”¨äºå­˜å‚¨å®é™…çš„ **å›è°ƒå¯¹è±¡** å’Œ **å›è°ƒä¸Šä¸‹æ–‡**ï¼ˆå®ç°ï¼‰
>   - ç”±äº `BindStateBase` çš„ **ææ„å‡½æ•° ä¸æ˜¯è™šå‡½æ•°**ï¼Œä¸”ä¸åŒç±»å‹çš„ `BindState<>` å®é™…å­˜å‚¨çš„æ•°æ®ä¸åŒï¼Œæ‰€ä»¥éœ€è¦å‘åŸºç±» `BindStateBase` ä¼ é€’å¯¹åº”çš„ `BindState<>::Destroy()` å‡½æ•°çš„æŒ‡é’ˆï¼Œç”¨äºé”€æ¯å­˜å‚¨çš„é—­åŒ…æ•°æ®
>   - åœ¨åŸºç±» `BindStateBase` ææ„æ—¶ï¼Œæ ¹æ® `destructor_` å­—æ®µï¼Œè°ƒç”¨ä¸åŒæ´¾ç”Ÿç±»çš„ `BindState<>::Destroy()` å‡½æ•°ï¼Œä»è€Œå®ç° **æ²¡æœ‰è™šå‡½æ•°çš„å¤šæ€**
> - å¦‚æœ `BindStateBase` çš„ `destructor_` **å­—æ®µè¢«ç¯¡æ”¹**ï¼Œå°±ä¼šå¯¼è‡´ **ææ„æ—¶å´©æºƒ**

å°±åƒæ˜¯å¥³æœ‹å‹ â€œä¹°å›æ¥ä½†æ˜¯ä¸ç©¿â€ çš„è£™å­ ğŸ‘— ä¸€æ · â€”â€” ç”±äº **å¼‚æ­¥** æ‰§è¡Œçš„ **å›è°ƒé—­åŒ…** ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œå®¹æ˜“æˆä¸ºå†…å­˜ç ´åçš„ â€œå—å®³è€…â€ã€‚

ğŸ•µï¸ ç¬¬äºŒæ­¥ï¼Œå…ˆå¤ç° â€œæ¡ˆå‘è¿‡ç¨‹â€ï¼Œå†ä» â€œæ¡ˆå‘ç°åœºâ€ å›æº¯ï¼Œ**å¯»æ‰¾å—å®³è€…** â€”â€” æ˜¯å“ªä¸ªå¯¹è±¡çš„æ•°æ®æŸåäº†ã€‚

ç”±äº `AtExitManager::tasks_` åªè®°å½•äº†å›è°ƒé—­åŒ…æœ¬èº«ï¼Œæ²¡æœ‰è®°å½•æ³¨å†Œæ¥æºï¼Œæ‰€ä»¥å¯ä»¥å€ŸåŠ© **æ–­ç‚¹å‘½ä»¤**ï¼Œåœ¨æ³¨å†Œä»»åŠ¡æ—¶çš„ `AtExitManager::RegisterTask()` æ‰“å° `task` å¯¹è±¡å’Œå½“å‰çš„ **è°ƒç”¨æ ˆ**ï¼Œå¹¶ç«‹å³ **ç»§ç»­æ‰§è¡Œ**ï¼š

```
(lldb) b AtExitManager::RegisterTask
Breakpoint 1: where = a.out`AtExitManager::RegisterTask(OnceCallback<void ()>) + 15 at insane_iterator.cc:238:5, address = 0x00000001000046ff
(lldb) br command add 1
Enter your debugger command(s).  Type 'DONE' to end.
> v task 
> v *task.bind_state_.__ptr_ 
> bt 
> c 
> DONE
```

é‡æ–°è¿è¡Œåï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ¬¡ å´©æºƒæ—¶è¢«ç¯¡æ”¹çš„ `BindStateBase` çš„å¯¹è±¡åœ°å€æ˜¯ `0x0000000100304500`ï¼š

```
Process 64246 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x1775946df44)
    frame #0: 0x000001775946df44
error: memory read failed for 0x1775946de00
Target 0: (a.out) stopped.
(lldb) up
frame #1: 0x0000000100008419 a.out`BindStateBase::~BindStateBase(this=0x0000000100304500) at insane_iterator.cc:26:22
```

æ ¹æ®å¯åŠ¨æ—¶ **æ–­ç‚¹å‘½ä»¤** æ‰“å°çš„æ—¥å¿—ï¼Œå¾—çŸ¥ â€œå—å®³è€…â€ æ˜¯ `TimestampManager` å•ä¾‹åˆ›å»ºæ—¶æ³¨å†Œçš„é”€æ¯å‡½æ•°ï¼Œè€Œä¸”åœ¨åˆ›å»ºæ—¶ `destructor_` å­—æ®µæ˜¯æ­£ç¡®çš„ï¼š

```
(lldb)  v task
(AtExitManager::Task) task = {
  CallbackBase = {
    bind_state_ = std::__1::shared_ptr<BindStateBase>::element_type @ 0x0000000100304500 strong=1 weak=1 {
      __ptr_ = 0x0000000100304500
    }
  }
}

(lldb)  v *task.bind_state_.__ptr_
(std::shared_ptr<BindStateBase>::element_type) *task.bind_state_.__ptr_ = {
  padding_ = ""
  polymorphic_invoke_ = 0x0000000100007860 (a.out`Invoker<BindState<void (*)()>, void ()>::RunOnce(BindStateBase*) at insane_iterator.cc:181)
  destructor_ = 0x00000001000079f0 (a.out`BindState<void (*)()>::Destroy(BindStateBase const*) at insane_iterator.cc:55)
}

(lldb)  bt
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
  * frame #0: 0x00000001000046ff a.out`AtExitManager::RegisterTask(task=AtExitManager::Task @ 0x00007ffeefbff660)>) at insane_iterator.cc:238:5
    frame #1: 0x0000000100004685 a.out`Singleton<TimestampManager>::get() at insane_iterator.cc:258:7
    frame #2: 0x0000000100003c59 a.out`TimestampManager::get() at insane_iterator.cc:273:43
    frame #3: 0x0000000100003bad a.out`main at insane_iterator.cc:316:3
    frame #4: 0x00007fff203a7621 libdyld.dylib`start + 1
```

ç»“åˆç¨‹åºçš„ **æºç **ï¼Œæ ¹æ®æ³¨å†Œæ—¶çš„ **è°ƒç”¨æ ˆ**ï¼Œåˆ†ææ³¨å†Œé€»è¾‘ï¼šåœ¨å•ä¾‹åˆ›å»ºæ—¶ï¼Œæ³¨å†Œä¸€ä¸ªé”€æ¯å•ä¾‹çš„å›è°ƒå‡½æ•°ï¼Œå¹¶åœ¨ç¨‹åºé€€å‡ºæ—¶æ‰§è¡Œã€‚ï¼ˆä»¥ä¸‹åˆ†æ **ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹**ï¼Œå…·ä½“å®ç°å‚è€ƒ [Chromium ä»£ç ](https://github.com/chromium/chromium)ï¼‰

> - æ³¨å†Œå‘ç”Ÿåœ¨ [`Singleton<>`](https://github.com/chromium/chromium/blob/master/base/memory/singleton.h) çš„è·å–å‡½æ•°é‡Œ
>   - `Singleton<>` æ˜¯ Chromium æä¾›çš„ä¸€ç§ **å•ä¾‹æ¨¡ç‰ˆ**
> - åœ¨é¦–æ¬¡è°ƒç”¨ `Singleton<>::get()` æ—¶ï¼Œå…ˆåˆ›å»ºå•ä¾‹å¯¹è±¡ï¼Œå¹¶åˆ©ç”¨ä¸Šæ–‡æåˆ°çš„ [`AtExitManager`](https://github.com/chromium/chromium/blob/master/base/at_exit.h) æ³¨å†Œå•ä¾‹çš„é”€æ¯å‡½æ•° `Singleton<>::OnExit()`
>   - ä»è€Œåœ¨ `AtExitManager` ææ„æ—¶ï¼Œæ‰§è¡Œå•ä¾‹çš„é”€æ¯é€»è¾‘

ğŸ•µï¸ ç¬¬ä¸‰æ­¥ï¼Œç›‘è§† â€œå—å®³è€…â€ çš„çŠ¶æ€å˜åŒ–ï¼Œå†æ¬¡å¤ç° â€œæ¡ˆå‘è¿‡ç¨‹â€ï¼Œåç­‰ **å‡¶æ‰‹è½ç½‘** â€”â€” æ˜¯è°ç¯¡æ”¹äº†å¯¹è±¡çš„æ•°æ®ã€‚

é‡æ–°è®¾ç½® **æ–­ç‚¹å‘½ä»¤**ï¼Œåœ¨æ³¨å†Œä»»åŠ¡æ—¶çš„ `AtExitManager::RegisterTask()` ä¸ºå°†æ¥å¯èƒ½æŸåçš„ `destructor_` å­—æ®µ **è®¾ç½®ç›‘è§†ç‚¹**ï¼ˆå¦å¤–ï¼Œä¹Ÿå¯ä»¥åªå¯¹ `TimestampManager` æ³¨å†Œçš„å¯¹è±¡ **è®¾ç½®ç›‘è§†ç‚¹**ï¼Œè€Œä¸éœ€è¦å…¨éƒ¨è®¾ç½®ï¼‰ï¼Œå¹¶ç«‹å³ **ç»§ç»­æ‰§è¡Œ**ï¼š

```
(lldb) br command add 1
Enter your debugger command(s).  Type 'DONE' to end.
> watch set variable &task.bind_state_.__ptr_->destructor_ 
> c 
> DONE
```

é‡æ–°è¿è¡Œåï¼Œå‘ç°åœ¨å´©æºƒå‰ **å‘½ä¸­ç›‘è§†ç‚¹**ï¼Œå†é€šè¿‡ **æŸ¥çœ‹è°ƒç”¨æ ˆ**ï¼Œå¯ä»¥å‘ç° `TimestampManager::UpdateTimestamp()` ç¯¡æ”¹äº† `destructor_` å­—æ®µï¼ˆä» `0x00000001000079f0` æ”¹ä¸ºé”™è¯¯çš„ `0x0000017759630984`ï¼‰ï¼š

```
Watchpoint 1 hit:
old value: 0x00000001000079f0
new value: 0x0000017759630984
Process 65204 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = watchpoint 1
    frame #0: 0x0000000100003d11 a.out`TimestampManager::UpdateTimestamp(this=0x00000001003044d0, key="???") at insane_iterator.cc:287:3
   286      iter->second = now;
-> 287    }
   288 
Target 0: (a.out) stopped.
(lldb) bt
* thread #1, queue = 'com.apple.main-thread', stop reason = watchpoint 1
  * frame #0: 0x0000000100003d11 a.out`TimestampManager::UpdateTimestamp(this=0x00000001003044d0, key="???") at insane_iterator.cc:287:3
    frame #1: 0x0000000100003bd8 a.out`main at insane_iterator.cc:316:28
    frame #2: 0x00007fff203a7621 libdyld.dylib`start + 1
```

æœ€åï¼Œ**æ°´è½çŸ³å‡º** â€”â€”

``` cpp
void TimestampManager::UpdateTimestamp(const std::string& key) {
  auto iter = timestamps_.find(key);
  if (iter == timestamps_.end()) {
    timestamps_.emplace(key, now);
    // return;
  }
  iter->second = now;
}
```

- ç”±äº `TimestampManager` å•ä¾‹åˆ›å»ºåï¼Œç«‹å³åˆ›å»ºäº†å¯¹åº”çš„ `BindStateBase` å¯¹è±¡ï¼Œæ‰€ä»¥ä¸¤ä¸ªå¯¹è±¡çš„ **å†…å­˜ä½ç½®éå¸¸æ¥è¿‘**ï¼Œæ‰å¯¼è‡´äº† `TimestampManager` å¯¹è±¡çš„ `timestamps_.end()->second` æ°å¥½å’Œ `BindStateBase` å¯¹è±¡çš„ `destructor_` å­—æ®µå¯¹åº”ç€ **åŒä¸€ä¸ªå†…å­˜ä½ç½®**
- ç”±äº `TimestampManager::UpdateTimestamp()` åˆ¤æ–­äº†è¿­ä»£å™¨ä¸åˆæ³•åï¼Œå¿˜è®°äº† `return`ï¼Œå¯¼è‡´ `iter->second = now` å†™å…¥ **é”™è¯¯çš„å†…å­˜ä½ç½®**
- ç”±äº `now` çš„å€¼æ˜¯ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œæ‰€ä»¥ æ¯æ¬¡æ‰§è¡Œæ—¶çš„å€¼ éƒ½ä¸ç›¸åŒï¼ˆå¥½åœ¨éƒ½ä¸æ˜¯åˆæ³•çš„å‡½æ•°æŒ‡é’ˆï¼‰

å…³äºè¿™æ¬¡å´©æºƒåˆ†æï¼Œåˆ†äº«å‡ ä¸ªæ€è€ƒ ğŸ’€ï¼š

- åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œå¯¹äºå†…å­˜ç ´åå´©æºƒï¼Œå³ä½¿æ‹¿åˆ°äº†å®Œæ•´çš„ â€œæ¡ˆå‘ç°åœºâ€ï¼Œå¯èƒ½ä¹Ÿæ— æµäºäº‹ â€”â€” â€œå‡¶æ‰‹â€ æ—©å·²ç¦»å¼€ç°åœº â€”â€” åªèƒ½é€šè¿‡å¤ç° â€œæ¡ˆå‘è¿‡ç¨‹â€ æ’æŸ¥é—®é¢˜
- å¦‚æœ `AtExitManager::tasks_` è®°å½•äº†å›è°ƒé—­åŒ…åˆ›å»ºçš„æ¥æºï¼ˆå‚è€ƒ [`base::TaskAnnotator::RunTask()`](https://github.com/chromium/chromium/blob/master/base/task/common/task_annotator.cc)ï¼‰ï¼Œä¼šé™ä½åˆ†æçš„éš¾åº¦ â€”â€” å³ä½¿é—®é¢˜æ— æ³•å¤ç°ï¼Œä¹Ÿèƒ½ä» â€œæ¡ˆå‘ç°åœºâ€ ä¸­ç›´æ¥æ‰¾åˆ° â€œå—å®³è€…â€
- å¦‚æœå’Œ `TimestampManager` å¯¹è±¡ç›¸é‚»çš„å†…å­˜ä½ç½®ï¼Œæ¯æ¬¡ä¸å›ºå®šï¼Œä¼šå¢åŠ å®šä½çš„éš¾åº¦ â€”â€” æ¯æ¬¡ â€œå—å®³è€…â€ ä¸ç›¸åŒï¼Œåˆ™æ— æ³•è¿›è¡Œ â€œé’ˆå¯¹æ€§ä¿æŠ¤â€
- å¦‚æœ `destructor_` æ°å¥½è¢«ä¿®æ”¹ä¸ºä¸€ä¸ª â€œå¯ä»¥æ­£å¸¸è°ƒç”¨â€ çš„å‡½æ•°æŒ‡é’ˆï¼ˆä¾‹å¦‚æ‰§è¡Œäº† `iter->second += N`ï¼‰ï¼Œä¼šå¢åŠ æ’æŸ¥çš„éš¾åº¦ â€”â€” â€œå—å®³è€…â€ å¯èƒ½æ— æ„ä¸­å˜æˆä¸‹ä¸€ä¸ª â€œå‡¶æ‰‹â€ â€”â€” å¯¼è‡´å…¶ä»–å†…å­˜è¢«ç ´åï¼Œä»è€Œå‡ºç° â€œè¿ç¯ä½œæ¡ˆâ€
- é»‘å®¢å¸¸å¸¸åˆ©ç”¨ç¨‹åºçš„æ¼æ´ï¼Œè¿›è¡Œ **ç¼“å†²åŒºæº¢å‡º** æ”»å‡»ï¼Œæ‰€ä»¥éœ€è¦ç¼–å†™ **å†…å­˜å®‰å…¨** çš„ä»£ç ï¼ˆä¾‹å¦‚ï¼Œæ­¤å¤„å¯ä»¥ä½¿ç”¨ `map.contains(key)` å’Œ `map.at(key)` ä»£æ›¿è¿­ä»£å™¨ï¼‰
- ç¼–å†™ **å†…å­˜å®‰å…¨** çš„ C++ ä»£ç çš„å…³é”®æ˜¯ â€”â€” ä¸€æ–¹é¢éœ€è¦æƒ³æ¸…æ¥š **æ¯ä¸ªå˜é‡** ä½•æ—¶åˆ›å»ºã€ä½•æ—¶é”€æ¯ã€è¢«è°è®¿é—®ã€è¢«è°ä¿®æ”¹ï¼Œ**æ¯ä¸ªå‡½æ•°** è¢«è°è°ƒç”¨ã€ä½•æ—¶è°ƒç”¨ã€ä½•å¤„è°ƒç”¨ï¼›å¦ä¸€æ–¹é¢å¯ä»¥å€ŸåŠ© **é™æ€/åŠ¨æ€/å·¥å…· æ£€æŸ¥**ï¼Œå°½æ—©å‘ç°é—®é¢˜ï¼ˆå…·ä½“å‚è€ƒ [æ¼«è°ˆ C++ çš„å„ç§æ£€æŸ¥](../2019/Cpp-Check.md) ğŸ‘ˆï¼‰

## è°ƒè¯•æ— å¤„ä¸åœ¨

> æ­£æ–‡å¼€å§‹ ğŸ™ƒ

### ä¸è°ƒè¯•å™¨å…±èˆ

å†™å®Œè¿™ä¸ªå°èŠ‚åï¼Œå¶ç„¶è¯»åˆ°ä¸€ç¯‡å…³äºè°ƒè¯•çš„æ–‡ç« ï¼š[Dancing in the Debugger â€” A Waltz with LLDB](https://www.objc.io/issues/19-debugging/lldb-debugging/) by _Ari Grant_ï¼ˆè¯‘æ–‡ï¼š[ä¸è°ƒè¯•å™¨å…±èˆ - LLDB çš„åå°”å…¹](https://objccn.io/issue-19-2/)ï¼‰ã€‚äºæ˜¯ï¼Œæˆ‘å†³å®šåˆ å‡è¿™ä¸ªå°èŠ‚ï¼Œå¹¶ **æ¨èè¿™ç¯‡æ–‡ç« **ï¼ˆè™½ç„¶è®²çš„æ˜¯ Objective-C å’Œ macos/iOS çš„å†…å®¹ï¼Œä½†æ˜¯æ€è·¯å€¼å¾—å€Ÿé‰´ï¼‰ï¼š

> ä½ æ˜¯å¦æ›¾ç»è‹¦æ¼äºç†è§£ä»£ç ï¼Œè€Œå»å°è¯•æ‰“å°ä¸€ä¸ªå˜é‡çš„å€¼ï¼Ÿ
> 
> ``` objc
> NSLog(@"%@", whatIsInsideThisThing);
> ```
> 
> æˆ–è€…è·³è¿‡ä¸€ä¸ªå‡½æ•°è°ƒç”¨æ¥ç®€åŒ–ç¨‹åºçš„è¡Œä¸ºï¼Ÿ
> 
> ``` objc
> NSNumber *n = @7;  // å®é™…åº”è¯¥è°ƒç”¨ Foo()ï¼Œè¿™é‡Œæ³¨é‡Šæ‰
> ```
> 
> æˆ–è€…çŸ­è·¯ä¸€ä¸ªé€»è¾‘æ£€æŸ¥ï¼Ÿ
> 
> ``` objc
> if (1 || theBooleanAtStake) { ... }
> ```
> 
> æˆ–è€…ä¼ªé€ ä¸€ä¸ªå‡½æ•°å®ç°ï¼Ÿ
> 
> ``` objc
> int calculateTheTrickyValue {
>   return 9;
>   /*
>    åè¾¹å†çœ‹çœ‹åœ¨å“ªå‡ºäº†é—®é¢˜
>    ...
>   */
> }
> ```
> 
> å¹¶ä¸”æ¯æ¬¡å¿…é¡»é‡æ–°ç¼–è¯‘ï¼Œç„¶åä»å¤´å¼€å§‹ï¼Ÿ

åˆšå­¦ä¹ ç¼–ç¨‹çš„æ—¶å€™ï¼Œå¤šæ•°äººï¼ˆåŒ…æ‹¬æˆ‘ï¼‰è¿˜ä¸ä¼šä½¿ç”¨è°ƒè¯•å™¨ï¼Œå°±è¿™æ ·è°ƒè¯•ä»£ç ã€‚ç„¶è€Œï¼Œç°åœ¨å‘¨å›´è¿˜æœ‰å¾ˆå¤šäººåœ¨ç”¨è¿™ç§ â€œåŸå§‹çš„æ–¹æ³•â€ æ’æŸ¥é—®é¢˜ ğŸ™„ã€‚

ä¹‹å‰æœ‰ä¸€ä½åŒäº‹å°±å’Œæˆ‘åæ§½ï¼Œç”¨ Python å¼€å‘æœåŠ¡æ•ˆç‡æ¯” C++ é«˜å¾ˆå¤šï¼š

- å…¶ä¸­ä¸€ä¸ªåŸå› æ˜¯ Python æœåŠ¡åœ¨æœåŠ¡å™¨ä¸Šä¿®æ”¹ä»£ç åï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€éªŒè¯
- ç„¶è€Œ C++ æœåŠ¡æ¯æ¬¡ æ”¹äº†ä¸€ä¸ªå‚æ•° æˆ–è€… åŠ äº†ä¸¤è¡Œæ—¥å¿—ï¼Œå°±è¦é‡æ–° **ç¼–è¯‘ã€æ‰“åŒ…ã€éƒ¨ç½²ã€è¿è¡Œ**ï¼ˆç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥å–æ¯æ°´ã€åˆ·åˆ·æ‰‹æœºï¼‰
- å¦‚æœå‘ç°åˆšåˆš æ”¹çš„å‚æ•°ä¸å¯¹ æˆ–è€… åŠ çš„æ—¥å¿—ä¸å¤Ÿç”¨ï¼Œè¿˜å¾— **å†æ¥ä¸€é**ï¼ˆåˆå¯ä»¥å†å–æ¯æ°´ã€ç»§ç»­åˆ·ä¸€ä¼šå„¿æ‰‹æœºï¼‰

äºæ˜¯æˆ‘å‘Šè¯‰ä»–ï¼Œå¯ä»¥ä½¿ç”¨ **è°ƒè¯•å™¨** æ’æŸ¥ C++ æœåŠ¡çš„é—®é¢˜ï¼šç°ä»£è°ƒè¯•å™¨ä¸€èˆ¬éƒ½æ”¯æŒ **æ–­ç‚¹å‘½ä»¤**ï¼ˆå‘½ä¸­æ–­ç‚¹åï¼Œå¯ä»¥æ‰§è¡Œè°ƒè¯•å™¨å‘½ä»¤ï¼‰å’Œ **æ¡ä»¶æ–­ç‚¹**ï¼ˆåªæœ‰æ»¡è¶³ç‰¹å®šæ¡ä»¶ï¼Œæ‰ä¼šå‘½ä¸­æ–­ç‚¹ï¼‰ï¼›ç”¨è°ƒè¯•å™¨ **é™„åŠ è¿›ç¨‹** åï¼Œé…åˆè¿™ä¸¤ä¸ªåŠŸèƒ½ï¼Œæ¯”ä¸€èˆ¬çš„æ—¥å¿—è¾“å‡ºåŠŸèƒ½ **æ›´å¼ºå¤§** â€”â€”

- é™¤äº†æ‰“å°å˜é‡çš„å€¼ï¼Œè¿˜å¯ä»¥æ‰“å° è°ƒç”¨æ ˆã€å¯„å­˜å™¨ã€å†…å­˜ ç­‰ **åŸå§‹çŠ¶æ€**
- å¦å¤–ï¼Œè¿˜å¯ä»¥ç›´æ¥ä¿®æ”¹ å˜é‡ã€å¯„å­˜å™¨ã€å†…å­˜ çš„çŠ¶æ€ï¼Œ**æ§åˆ¶æ‰§è¡Œæµç¨‹**
- å…³é”®åœ¨äºï¼Œä¸Šè¿°æ“ä½œ **æ— éœ€ä¿®æ”¹ä»£ç **

è¿™ä½åŒäº‹ç”¨ä¸Šè°ƒè¯•å™¨ä¸€æ®µæ—¶é—´åï¼Œå‘æˆ‘ â€œè¯‰è‹¦â€ï¼šâ€œæ‘¸é±¼â€ çš„æœºä¼šå˜å°‘äº† ğŸ™ƒã€‚

### èä¼šè´¯é€š

å°½ç®¡ä¸åŒè°ƒè¯•å™¨çš„ç”¨æ³•ä¸åŒï¼Œä½†åŸç†éƒ½æ˜¯ç›¸ä¼¼çš„ã€‚è¿™ä¸ªå°èŠ‚æ€»ç»“äº†å¸¸ç”¨å‘½ä»¤çš„ä¸€äº›ä½¿ç”¨åœºæ™¯ã€‚

**æœç´¢ç¬¦å·**ï¼š

- æœç´¢ **å‡½æ•°å…¥å£**ï¼Œå¯ä»¥ç”¨äºè®¾ç½®æ–­ç‚¹
- **åˆ—ä¸¾æ¨¡å—**ï¼ŒæŸ¥çœ‹è¿›ç¨‹åŠ è½½äº†å“ªäº›æ¨¡å—ï¼ŒåŠå…¶å†…å­˜åœ°å€èŒƒå›´

**æ–­ç‚¹**ï¼š

- æ‰§è¡Œåˆ°ç‰¹å®šçš„ **å‡½æ•°** æˆ–å‡½æ•°ä¸­çš„æŸä¸ª **æ­¥éª¤** æ—¶ï¼Œ**æš‚åœè¿›ç¨‹**
- è¿›ç¨‹æš‚åœåï¼Œå¯ä»¥è¯»å–/ä¿®æ”¹ **å˜é‡ã€å¯„å­˜å™¨ã€å†…å­˜** çš„çŠ¶æ€

**ç›‘è§†ç‚¹**ï¼š

- è®¿é—®ç‰¹å®š **å†…å­˜ä½ç½®** æ—¶ï¼Œ**æš‚åœè¿›ç¨‹**
- ç”¨äºè§‚å¯Ÿ **éæ ˆä¸Šçš„å˜é‡** çš„è®¿é—®æƒ…å†µã€å¼•ç”¨å…³ç³»ï¼ˆæ ˆä¸Šå˜é‡å¯ä»¥åˆ©ç”¨ **å•æ­¥è°ƒè¯•** è§‚å¯Ÿï¼‰
- éœ€è¦æ³¨æ„ å˜é‡çš„å†…å­˜åœ°å€ æ˜¯ è¿è¡Œæ—¶åŠ¨æ€åˆ†é… çš„

**æ–­ç‚¹/ç›‘è§†ç‚¹ å‘½ä»¤**ï¼š

- å‘½ä¸­æ–­ç‚¹/ç›‘è§†ç‚¹å **æ‰§è¡Œå‘½ä»¤**
- ä¸€ä¸ªæŠ€å·§æ˜¯ï¼šå…ˆè¯»å–/ä¿®æ”¹ **å˜é‡ã€å¯„å­˜å™¨ã€å†…å­˜** çŠ¶æ€ï¼Œå†ç«‹å³ **ç»§ç»­æ‰§è¡Œ** â€”â€” ä»è€Œå®ç°äº† æ‰“å°æ—¥å¿—ã€æ§åˆ¶æ‰§è¡Œæµç¨‹ çš„åŠŸèƒ½
- é€šè¿‡ä¿®æ”¹è¿”å›å€¼ï¼Œå¯ä»¥ **è‡ªå®šä¹‰è·³è½¬** é€»è¾‘
  - å¦‚æœæœ‰ç¬¦å·ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ `thread return` ç­‰å‘½ä»¤
  - å¦‚æœæ— ç¬¦å·ï¼Œå¯ä»¥å…ˆä¿®æ”¹è¿”å›å€¼ï¼Œå†ä½¿ç”¨ `jump` ç­‰å‘½ä»¤

**æ¡ä»¶ æ–­ç‚¹/ç›‘è§†ç‚¹**ï¼š

- **æŒ‰éœ€** å‘½ä¸­æ–­ç‚¹/ç›‘è§†ç‚¹
- å®ç°äº† `if(condition) ä¸­æ–­; else ç»§ç»­æ‰§è¡Œ;` çš„åŠŸèƒ½
- é…åˆ **æ–­ç‚¹/ç›‘è§†ç‚¹ å‘½ä»¤**ï¼Œå¯ä»¥å®ç° **æ¡ä»¶è·³è½¬**

**è°ƒç”¨æ ˆ**ï¼š

- è¿›ç¨‹æš‚åœåï¼ŒæŸ¥çœ‹ï¼ˆæ‰€æœ‰çº¿ç¨‹çš„ï¼‰**å‡½æ•°è°ƒç”¨å…³ç³»**
- **åˆ‡æ¢æ ˆå¸§**ï¼ŒæŸ¥çœ‹ ä¸åŒå‡½æ•° é‡Œçš„ å˜é‡å€¼ï¼ˆå¯„å­˜å™¨ ä¸ä¼šåˆ‡æ¢ï¼‰
- **åˆ‡æ¢çº¿ç¨‹**ï¼ŒæŸ¥çœ‹ ä¸åŒçº¿ç¨‹ é‡Œçš„ è°ƒç”¨æ ˆï¼ˆå¯„å­˜å™¨ éšä¹‹åˆ‡æ¢ï¼‰

**å•æ­¥è°ƒè¯•**ï¼š

- **åŠ¨æ€** è§‚å¯Ÿå‡½æ•°çš„ **æ‰§è¡Œæµç¨‹**
- step-over è·Ÿè¸ª **å‡½æ•°å†…éƒ¨** çš„æ‰§è¡Œæµç¨‹
- step-in/out è·Ÿè¸ª **å‡½æ•°ä¹‹é—´** çš„è°ƒç”¨å…³ç³»
- stop-hook åœ¨æ¯æ¬¡æš‚åœæ—¶ æ‰§è¡Œå‘½ä»¤ï¼ˆä¾‹å¦‚ `display`/`watch` æ‰“å°å˜é‡ï¼‰

**åæ±‡ç¼–**ï¼š

- **é™æ€** é˜…è¯»å‡½æ•°çš„ **æ‰§è¡Œæµç¨‹**
- å»ºè®®ä¼˜å…ˆ **åŠ è½½ç¬¦å·** å¹¶ **é…ç½®æºç è·¯å¾„**ï¼Œè€Œä¸åªæ˜¯çœ‹åæ±‡ç¼–
- å¦‚æœæºç ç»è¿‡ä¼˜åŒ–ï¼ˆä¾‹å¦‚å‡½æ•°çš„ **å†…è”** _(inline)_ ä¼˜åŒ–ã€ä¸Šæ–‡æåˆ°çš„ _FPO_ï¼‰ï¼Œå»ºè®®ä¼˜å…ˆæŸ¥çœ‹åæ±‡ç¼–ï¼ˆæ‰€ä»¥å¾ˆå¤šå›¢é˜Ÿä¸è®©ç”¨ `-O3` ç¼–è¯‘ï¼‰

**å†…å­˜æœç´¢**ï¼š

- åœ¨å†…å­˜ä¸­æŸ¥æ‰¾ ç‰¹å®šå­—èŠ‚ï¼ˆä½†ç»“æœä¸­å­˜åœ¨å¹²æ‰°ï¼Œä¸å¦‚æ–­ç‚¹å¥½ç”¨ï¼‰
- **æœç´¢å­—ç¬¦ä¸²**ï¼Œç”¨äºå¯»æ‰¾ éæ ˆä¸Šçš„å˜é‡ çš„ä½ç½®ï¼ˆéœ€è¦åŒºåˆ† `char`/`wchar_t`ï¼‰
- **æœç´¢è™šå‡½æ•°è¡¨æŒ‡é’ˆ**ï¼Œç”¨äºæŸ¥æ‰¾ç‰¹å®šå¯¹è±¡çš„ æ‰€æœ‰å®ä¾‹ï¼ˆå¦‚æœæ˜¯å•ä¾‹ï¼Œä¼šç®€å•ä¸€äº›ï¼‰
- å¼ºçƒˆæ¨è å¼ é“¶å¥çš„[ã€Šä»å †é‡Œå¯»æ‰¾ä¸¢å¤±çš„æ•°æ®ã€‹](http://advdbg.org/blogs/advdbg_system/articles/3413.aspx)

**æ‰§è¡Œè„šæœ¬**ï¼š

- åˆ©ç”¨ Python è„šæœ¬ï¼Œå®ç° **å¤æ‚åŠŸèƒ½**
- ä¾‹å¦‚ é…ç½®ç‰¹å®š C++ æ•°æ®ç±»å‹çš„ **æ‰“å°æ ¼å¼**

æœ€åï¼Œæ›´å¤šç»†èŠ‚æ¨èé˜…è¯»ï¼š

- ã€ŠC++ åæ±‡ç¼–ä¸é€†å‘åˆ†ææŠ€æœ¯æ­ç§˜ã€‹é’±æ—æ¾ èµµæµ·æ—­
- ã€Šè½¯ä»¶è°ƒè¯•ã€‹å¼ é“¶å¥

### è¾…åŠ©å·¥å…·

é™¤äº†ä½¿ç”¨è°ƒè¯•å™¨ï¼Œè¿˜å¯ä»¥å€ŸåŠ© **å·¥å…·** è§‚å¯Ÿç¨‹åºè¡Œä¸ºï¼Œå†æŒ‚ä¸Šè°ƒè¯•å™¨ **å¯¹ç—‡ä¸‹æ–­ç‚¹**ã€‚è¿™ä¸ªå°èŠ‚åˆ†äº«å‡ ä¸ª Windows ä¸Šçš„å·¥å…·ï¼ˆé¡ºä¾¿æ€€å¿µä¸€ä¸‹ä½¿ç”¨ Windows åŠå…¬çš„æ—¶å…‰ ğŸ˜¶ï¼‰ã€‚

**æ‰¾ä¸åˆ° DLL**ï¼š

> ğŸ’¡ [Process Monitor](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon) å¯ä»¥ç›‘æ§è¿›ç¨‹çš„ **æ³¨å†Œè¡¨æ“ä½œã€æ–‡ä»¶ I/Oã€ç½‘ç»œ I/Oã€çº¿ç¨‹æ´»åŠ¨** ç­‰è¡Œä¸ºï¼Œå¹¶è®°å½•æ¯ä¸ªè¡Œä¸ºå¯¹åº”çš„ **è°ƒç”¨æ ˆ**ï¼Œè¿˜æ”¯æŒ **åŠ è½½ç¬¦å·**ã€‚

åˆšè£…ä¸Šçš„ lldb æ— æ³•è¿è¡Œï¼Œè£…äº† Python 3.6 ä¹Ÿä¸è¡Œï¼š

[img=border:outset]

![Windows-Dll-Not-Found](Debug-Everywhere/Windows-Dll-Not-Found.png)

æ ¹æ®æ–‡ä»¶ I/O è®°å½•ï¼Œå‘ç° Python 3.6 ä¸åœ¨è·¯å¾„çš„æœç´¢èŒƒå›´å†…ï¼›ç”±æ­¤å¯ä»¥æ¨æ–­æ˜¯ç¯å¢ƒå˜é‡ `%PATH%` çš„é…ç½®é—®é¢˜ï¼š

[img=border:outset]

![Windows-Procmon](Debug-Everywhere/Windows-Procmon.png)

è¿˜æœ‰ä¸€æ¬¡ï¼Œå€ŸåŠ©è¿™ä¸ªå·¥å…·ï¼Œé€†å‘åˆ†æäº†æŸå®¢æˆ·ç«¯çš„å´©æºƒé—®é¢˜ï¼š

- å¦‚æœç”¨æˆ·ååŒ…å«ä¸­æ–‡ï¼Œåœ¨è®¿é—® `%appdata%` æ—¶ï¼Œä¼ å…¥äº† **ç¼–ç é”™è¯¯çš„å­—ç¬¦ä¸²**ï¼Œå¯¼è‡´è®¿é—®å¤±è´¥
- è€Œè¯¥å®¢æˆ·ç«¯çš„åç»­é€»è¾‘ï¼Œæ²¡æœ‰è€ƒè™‘åˆ° `CreateFile()` è°ƒç”¨å¤±è´¥çš„æƒ…å†µï¼Œä»è€Œå¯¼è‡´å´©æºƒ ğŸ˜¶

å¦å¤–ï¼Œè¿™ä¸ªå·¥å…·è¿˜èƒ½ç”¨äº è§‚å¯ŸæŸäº›åå°è¿›ç¨‹æ˜¯ä¸æ˜¯åœ¨ â€œå¹²åäº‹â€ ğŸ™„ï¼ˆæ¨èé˜…è¯»ï¼š[ã€Šå…³äº QQ è¯»å– Chrome å†å²è®°å½•çš„æ¾„æ¸…ã€‹](https://bbs.pediy.com/thread-265359.htm) by _qwqdanchun_ï¼‰

**æ–‡ä»¶è¢«å ç”¨**ï¼š

> ğŸ’¡ [Process Explorer](https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer) å¯ä»¥åˆ—ä¸¾æ‰€æœ‰è¿›ç¨‹çš„ **çˆ¶å­å…³ç³»ã€æ‰“å¼€çš„å¥æŸ„ã€åŠ è½½çš„æ¨¡å—ã€èµ„æºå ç”¨ã€è¿è¡Œå‚æ•°** ç­‰ä¿¡æ¯ï¼Œå¯ç”¨äºæ›¿æ¢ ç³»ç»Ÿè‡ªå¸¦çš„ä»»åŠ¡ç®¡ç†å™¨ã€‚

æ¯å½“åˆ é™¤æ–‡ä»¶æˆ–ç›®å½•æ—¶ï¼Œå¸¸ä¼šå‘ç°è¢«æŸäº›ç¨‹åºå ç”¨ï¼š

[img=border:outset]

![Windows-File-In-Use](Debug-Everywhere/Windows-File-In-Use.png)

é€šè¿‡æœç´¢ï¼Œå‘ç°è¯¥ç›®å½•é‡Œçš„ `ruby.exe` æ­£åœ¨è¿è¡Œï¼Œç›®å½•é‡Œçš„ä¸€äº› DLL è¢«åŠ è½½ï¼š

[img=border:outset]

![Windows-Procexp](Debug-Everywhere/Windows-Procexp.png)

**æœªçŸ¥å¼¹çª—**ï¼š

> ğŸ’¡ [Process Explorer](https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer) è¿˜æ”¯æŒé€šè¿‡ **çª—å£å¥æŸ„** æœç´¢è¿›ç¨‹ï¼Œå¯ç”¨äºå®šä½çª—å£æ‰€åœ¨è¿›ç¨‹ã€‚ï¼ˆæœ€è¿‘çœ‹åˆ° macOS ä¸Šæœ‰ä¸ª [SonOfGrab](https://developer.apple.com/library/archive/samplecode/SonOfGrab/Introduction/Intro.html) ä¹Ÿæ”¯æŒç±»ä¼¼åŠŸèƒ½ï¼‰

å½“ä½ çªç„¶çœ‹åˆ°ä¸€ä¸ªå¼¹çª—ï¼Œéœ€è¦ **å…ˆç¡®å®šæ˜¯å“ªä¸ªè¿›ç¨‹** å¼¹å‡ºçš„ï¼Œç„¶åæ‰èƒ½æŒ‚ä¸Šè°ƒè¯•å™¨ã€‚

å…·ä½“æ¡ˆä¾‹éå¸¸å¤šï¼Œå¦‚æœä½ è£…äº†æŸè¾“å…¥æ³•ï¼Œå³ä¸‹è§’æ€»ä¼šå¼¹å‡ºå„ç§å¥‡æ€ªçš„å°çª— ğŸ™ˆã€‚

**åˆ†æå´©æºƒ**ï¼š

> ğŸ’¡ Dump æ–‡ä»¶å°±åƒç…§ç‰‡ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½å¯èƒ½è®©æˆ‘ä»¬æƒ³èµ·ä¸€æ®µæ•…äº‹ï¼Œæ—¶é—´è¶Šé•¿ï¼Œè¶Šå€¼å¾—å›å‘³ã€‚â€”â€”ã€Šæ ¼è ¹æ±‡ç¼–ã€‹å¼ é“¶å¥

è°ƒè¯•å™¨é™¤äº†å¯ä»¥ç”¨äºè°ƒè¯•ç¨‹åºï¼Œè¿˜èƒ½ç”¨äºåˆ†æå´©æºƒ **è½¬å‚¨** _(dump)_ æ–‡ä»¶ã€‚

å¾ˆå¤šäººæ‹¿åˆ°ä¸€ä¸ª dump æ–‡ä»¶ï¼Œåªçœ‹å´©æºƒæ—¶çš„è°ƒç”¨æ ˆï¼Œè€Œå¿½ç•¥äº†ä¸°å¯Œçš„ å¯„å­˜å™¨ã€å†…å­˜ã€çº¿ç¨‹ ç­‰ä¿¡æ¯ï¼›è€Œè¿™äº›æ•°æ®å¾€å¾€æ˜¯ æ’æŸ¥é—®é¢˜çš„å…³é”® â€”â€”

- å¦‚æœæ•´ä¸ª dump æ–‡ä»¶æ˜¯ä¸€å¼  â€œæ¡ˆå‘ç°åœºâ€ çš„ä¸€äº¿åƒç´ ç…§ç‰‡
- é‚£ä¹ˆ å´©æºƒçº¿ç¨‹çš„è°ƒç”¨æ ˆ åªæ˜¯å®ƒçš„ 32kb ç¼©ç•¥å›¾ 

å€ŸåŠ© dump æ–‡ä»¶çš„ä¸°å¯Œä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ **å˜é‡ã€å¯„å­˜å™¨ã€å†…å­˜** çš„çŠ¶æ€ï¼Œè®©ç¨‹åºè¿›å…¥ **é¢„æœŸçš„åˆ†æ”¯**ï¼Œè¿˜åŸå´©æºƒå‰çš„åœºæ™¯ï¼Œå¤ç°ä¸€äº›éš¾ä»¥å¤ç°çš„é—®é¢˜ â€”â€” é™æ€åˆ†æå´©æºƒçŠ¶æ€ + åŠ¨æ€åˆ†ææ‰§è¡Œæµç¨‹ = æ•ˆç‡æ›´é«˜ ğŸ˜ã€‚

æœ€ååˆ†äº«ä¸€ä¸ª **æ— çº¿ç½‘å¡é©±åŠ¨ è“å±å´©æºƒ** çš„å¸¸è§è§£å†³æ–¹æ¡ˆï¼ˆå±¡è¯•ä¸çˆ½ ğŸ˜‚ï¼‰ï¼š

<p><details>
<summary> ğŸ‘‰ æˆªå›¾è¾ƒé•¿ï¼Œç‚¹å‡»å±•å¼€ ğŸ‘ˆ </summary>
<img src="Debug-Everywhere/Windows-Blue-Screen.jpg"
     alt="Windows-Blue-Screen" style="border:solid thin" />
</details></p>

å…³äºå´©æºƒçš„è¯é¢˜ï¼Œä¸‹æ¬¡æœ‰æœºä¼šå†ç»†èŠ ğŸ™ƒã€‚

## å†™åœ¨æœ€å

> We all earn our pay and reputations not by how we debug, but by how quickly and accurately we do it. â€”â€” Mark Russinovich

Mark Russinovich åœ¨ã€ŠWindows é«˜çº§è°ƒè¯•ã€‹åºè¨€é‡Œè¯´åˆ°ï¼šâ€œæˆ‘ä»¬çš„å·¥ä½œèƒ½åŠ›å¹¶ä¸åœ¨äºå¦‚ä½•è°ƒè¯•é—®é¢˜ï¼Œè€Œæ˜¯åœ¨äºè°ƒè¯•é—®é¢˜çš„é€Ÿåº¦å’Œå‡†ç¡®åº¦ã€‚â€

æ‰€ä»¥ï¼Œä¸€èµ·æŒ‚ä¸Šè°ƒè¯•å™¨ â€œé‡æ–°è®¤è¯†â€ ä¸–ç•Œå§ã€‚

æ„Ÿè°¢å…³æ³¨ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½å¯¹ä½ æœ‰å¸®åŠ©ã€‚å¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œ**æ¬¢è¿äº¤æµ**ã€‚ğŸ˜„

Delivered under MIT License &copy; 2021, BOT Man
