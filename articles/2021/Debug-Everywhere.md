# ä¸€åˆ‡çš†å¯è°ƒè¯•

> 2021/1/10
> 
> Debugging is twice as hard as writing the code in the first place. â€”â€” Kernighanâ€™s Law

## å†™åœ¨å‰é¢ TL;DR [no-toc]

> åœ¨ä¸€æ¬¡å­¦æ ¡ç¤¾å›¢çš„æŠ€æœ¯åˆ†äº«ä¸­ï¼Œä¸¤ä½ â€œé»‘å®¢â€ åŒå­¦åˆ†äº«äº†ï¼šå¦‚ä½•ç”¨ **ä¸€ä¸ªä¸‹åˆçš„æ—¶é—´** ç ´è§£æŸè‹±è¯­å­¦ä¹ å®¢æˆ·ç«¯ â€”â€” å­¦ç”Ÿæ— éœ€å­¦ä¹ è¯¾ç¨‹ï¼Œå³å¯è‡ªåŠ¨å®Œæˆè€ƒè¯•ã€‚
> 
> ä»¤æˆ‘å°è±¡æœ€æ·±åˆ»çš„æ˜¯ï¼šåŸæœ¬ç”¨äºè°ƒæ•´éŸ³é‡çš„æ»‘å—ï¼Œè¢«é­”æ”¹ç”¨æ¥è¾“å…¥è€ƒè¯•å¾—åˆ† â€”â€” åˆ©ç”¨åŠ¨æ€è§„åˆ’ï¼Œæ¨¡æ‹Ÿç­”é”™ä¸€äº›é¢˜ç›®ï¼Œæœ€åæäº¤ç¬¦åˆé¢„æœŸæ€»åˆ†å¾—ç­”æ¡ˆï¼ˆæ¯•ç«Ÿä¸èƒ½å…¨æ˜¯æ»¡åˆ† ğŸ˜¶ï¼‰ã€‚
> 
> å½“æ—¶ï¼Œæˆ‘ â€œå¹¼å°çš„å¿ƒçµâ€ å—åˆ°äº† å·¨å¤§çš„éœ‡æ’¼ â€”â€” åªè¦å­¦ä¼šäº† **é€†å‘å’Œè°ƒè¯•**ï¼Œå°±å¯ä»¥ â€œéšå¿ƒæ‰€æ¬²â€ äº†ï¼ˆå½“ç„¶ä¹Ÿå¾— â€œä¸é€¾çŸ©â€ ğŸ™‚ï¼‰ã€‚äºæ˜¯ï¼Œæˆ‘å¼€å§‹å‘ä»–ä»¬å­¦ä¹ ï¼

ç°åœ¨ï¼Œæˆ‘é€æ¸å­¦ä¼šäº† â€œåœ¨è°ƒè¯•å™¨é‡Œçœ‹ä¸–ç•Œâ€ï¼Œä¹Ÿæé«˜äº†æ’æŸ¥é—®é¢˜çš„é€Ÿåº¦ã€‚æœ¬æ–‡å…ˆåˆ†äº«ä¸€ä¸ª â€œå®¢åœºä½œæˆ˜â€ çš„æ•…äº‹ï¼Œå†æ€»ç»“ä¸€äº›å¿ƒå¾—å’ŒæŠ€å·§ï¼š

[TOC]

## ä¸€æ¬¡å®¢åœºä½œæˆ˜ TL;DR

> å¦‚æœå¯¹æ•…äº‹ä¸æ„Ÿå…´è¶£ï¼Œå¯ä»¥ç›´æ¥é˜…è¯» [sec|è°ƒè¯•æ— å¤„ä¸åœ¨] ğŸ˜¶

### ç³Ÿç³•çš„ç”¨æˆ·ä½“éªŒ

ç”±äºå…¬å¸é…äº† Macbook Proï¼Œä¸å¾—ä¸ç”¨å®ƒ ~~ï¼ˆç—›è‹¦çš„ ğŸ˜­ï¼‰~~ è¿›è¡Œæ—¥å¸¸å·¥ä½œã€‚~~å½“ç„¶ï¼Œä½œä¸ºéŸ³å“è¿˜æ˜¯å¾ˆä¸é”™çš„ã€‚ã€‚ã€‚ï¼ˆä¸è¿‡å°±æ˜¯æœ‰ç‚¹è´µ ğŸ˜¶ï¼‰~~

ç„¶è€Œ macOS ä¸Šçš„å¾ˆå¤šè½¯ä»¶ï¼ˆå°¤å…¶æ˜¯å›½äº§è½¯ä»¶ï¼‰éƒ½æ²¡æœ‰ç»è¿‡ä»”ç»†æ‰“ç£¨ â€”â€” è¦ä¹ˆæ˜¯åŠŸèƒ½ç¼ºå¤±ï¼ˆè¿™è®©æˆ‘å›å¿†èµ·ç”¨ Windows Phone çš„ä¸‰å¹´æ—¶å…‰ï¼‰ï¼Œè¦ä¹ˆæ˜¯ç”¨èµ·æ¥ç¡Œç¡¬ï¼ˆå¾ˆå¤šæ˜æ˜¾çš„ bug éƒ½æ²¡äººä¿®ï¼‰ã€‚

å…¶ä¸­æœ‰å¾ˆå¤šè½¯ä»¶éƒ½å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šä»–ä»¬çš„æ•´ä¸ªæ ‡é¢˜æ éƒ½èƒ½æ‹–åŠ¨ï¼Œä½†åªæœ‰ä¸ŠåŠéƒ¨åˆ†æ”¯æŒåŒå‡»æ”¾ç¼©ï¼Œä¸‹åŠéƒ¨åˆ†å´åªèƒ½æ‹–åŠ¨ â€”â€”

![MacQQ-Bug](Debug-Everywhere/MacQQ-Bug.png)

å¦‚æœä¸å°å¿ƒåŒå‡»äº†ä¸‹åŠéƒ¨åˆ†ï¼Œæ€»ä»¥ä¸ºæ˜¯ç¨‹åºå¡ä½äº†ï¼›ä½†æ˜¯æŠŠé¼ æ ‡å¾€ä¸Šç§»ä¸€äº›å†åŒå‡»ï¼Œåˆå¯ä»¥æ”¾ç¼©äº† â€”â€” æ„Ÿè§‰å—åˆ°äº†æ¬ºéª— ğŸ˜¡ã€‚

ä½œä¸ºå¤šå¹´ Windows ç”¨æˆ·ï¼Œå®åœ¨å¿æ— å¯å¿ï¼Œäºæ˜¯ï¼Œå…ˆä»æœ€å¸¸ç”¨çš„ QQ ä¸‹æ‰‹ â€”â€”

### ä¸è¯´åˆ«çš„ï¼Œä¸Šè°ƒè¯•å™¨

æ°å¥½ macOS ä¸Šé¢„è£…æœ‰ lldbï¼ˆç»ˆç«¯é‡Œç›´æ¥æ•² lldb å³å¯å®‰è£… ğŸ‘ï¼‰ï¼Œè¿™æ¬¡å°±æ²¡æœ‰ç”¨ gdbï¼ˆå½“ç„¶ macOS ä¸Šä¹Ÿæ²¡æœ‰ WinDbg ğŸ™ƒï¼‰ã€‚

> ğŸ’¡ å¦‚æœä¸çŸ¥é“å¦‚ä½•ä½¿ç”¨è°ƒè¯•å™¨ï¼Œæ¨èé˜…è¯» [LLDB æ•™ç¨‹](https://lldb.llvm.org/use/tutorial.html)ï¼›å¦‚æœä¸ç†Ÿæ‚‰ lldb å‘½ä»¤ï¼Œå¯ä»¥å‚è€ƒ [GDB/LLDB å‘½ä»¤æ˜ å°„è¡¨](https://lldb.llvm.org/use/map.html)ã€‚

ç”±äº QQ çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæœ¬æ–‡ä½¿ç”¨çš„æ˜¯æœ€æ–°çš„ [6.7.3 ç‰ˆæœ¬](https://dldir1.qq.com/qqfile/QQforMac/QQ_6.7.3.dmg)ï¼‰ä½¿ç”¨äº†ç­¾åï¼Œ[è°ƒè¯•å‰éœ€è¦å…ˆå»æ‰ç­¾å](https://reverseengineering.stackexchange.com/questions/13622/remove-code-signature-from-a-mac-binary)ï¼š

```
codesign --remove-signature /Applications/QQ.app/Contents/MacOS/QQ
```

> ğŸ’¡ ç£¨åˆ€ä¸è¯¯ç æŸ´å·¥ â€”â€” èƒŒæ™¯è°ƒç ”ï¼Œéå¸¸å…³é”®ã€‚

æ‹¿åˆ°ä¸€ä¸ªæ–°é—®é¢˜åï¼Œéœ€è¦å…ˆç®€å•äº†è§£ä¸€äº›ç›¸å…³çŸ¥è¯†ï¼š

- [æ ¹æ®ç½‘å‹çš„å›ç­”](https://apple.stackexchange.com/questions/95681/how-can-i-change-os-x-double-click-on-title-bar-to-be-like-windows/232153#232153)ï¼Œæˆ‘ä»¬çŸ¥é“ï¼š
  - åŒå‡»çš„è‹±æ–‡æ˜¯ double click
  - æ ‡é¢˜æ çš„è‹±æ–‡æ˜¯ title barï¼ˆåè¾¹å‘ç°åº”è¯¥æ˜¯ titlebar ğŸ™ƒï¼‰
  - æ”¾ç¼©çª—å£çš„è‹±æ–‡æ˜¯ zoom window
  - è€Œè¿™ä¸ªåŠŸèƒ½æ˜¯ä» macOS Catalina 10.15 å¼€å§‹æ”¯æŒçš„
- macOS åŸºäº [Cocoa UI æ¡†æ¶](https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/OSX_Technology_Overview/CocoaApplicationLayer/CocoaApplicationLayer.html)ï¼Œç”¨çš„æ˜¯ [Objective-C è¯­è¨€](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ProgrammingWithObjectiveC/Introduction/Introduction.html)ï¼ˆæˆ‘æƒŠå–œçš„å‘ç° â€”â€” å³ä½¿ä¸ä¼šï¼Œä¹Ÿä¸å½±å“è°ƒè¯• ğŸ™‚ï¼‰ï¼Œæ ¸å¿ƒæ¨¡å—æ˜¯ [AppKit](https://developer.apple.com/documentation/appkit?language=objc) æ¡†æ¶
- [æ ¹æ®é¼ æ ‡ç›¸å…³çš„æ–‡æ¡£](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/EventOverview/HandlingMouseEvents/HandlingMouseEvents.html#//apple_ref/doc/uid/10000060i-CH6-SW17)ï¼Œæˆ‘ä»¬çŸ¥é“ï¼š
  - é¼ æ ‡ç‚¹å‡»äº‹ä»¶åˆ†ä¸º [`mouseDown:`](https://developer.apple.com/documentation/appkit/nsresponder/1524634-mousedown) å’Œ [`mouseUp:`](https://developer.apple.com/documentation/appkit/nsresponder/1535349-mouseup)ï¼ˆæ³¨æ„ç»“å°¾çš„å†’å· `:`ï¼‰
  - é¼ æ ‡äº‹ä»¶çš„ç±»å‹æ˜¯ [`NSEvent`](https://developer.apple.com/documentation/appkit/nsevent)ï¼Œè€Œå¯ä»¥é€šè¿‡ [`clickCount`](https://developer.apple.com/documentation/appkit/nsevent/1528200-clickcount) åˆ¤æ–­å•å‡»è¿˜æ˜¯åŒå‡»ï¼ˆç»“å°¾æ²¡æœ‰å†’å· `:`ï¼‰
  - æœ‰æ— ç»“å°¾çš„å†’å· `:` ä¼šè¢«è®¤ä¸ºæ˜¯ **ä¸¤ä¸ªä¸åŒçš„ç¬¦å·**ï¼ˆä¸‹æ–­ç‚¹çš„æ—¶å€™éœ€è¦æ³¨æ„ ğŸ˜¶ï¼‰
- [æ ¹æ®çª—å£ç›¸å…³çš„æ–‡æ¡£](https://developer.apple.com/documentation/appkit/nswindow)ï¼Œæˆ‘ä»¬çŸ¥é“ï¼š
  - Cocoa ç¨‹åºçš„çª—å£æ˜¯ [`NSWindow`](https://developer.apple.com/documentation/appkit/nswindow) ç±»
  - çª—å£æœ€å¤§åŒ– éœ€è¦è°ƒç”¨ [`performZoom:`](https://developer.apple.com/documentation/appkit/nswindow/1419450-performzoom) æ–¹æ³•
  - çª—å£å…¨å± åˆ™æ˜¯è°ƒç”¨ [`toggleFullScreen:`](https://developer.apple.com/documentation/appkit/nswindow/1419527-togglefullscreen) æ–¹æ³•
  - å…¨å±å’Œæœ€å¤§åŒ–æ˜¯ **ä¸¤ä¸ªä¸åŒçš„æ“ä½œ**ï¼ˆç›®å‰ç”¨çš„è¿˜ä¸å¤ªä¹ æƒ¯ ğŸ˜¶ï¼‰

> ğŸ’¡ ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå¯ä»¥é…ç½® `.lldbinit`/`.gdbinit` æ–‡ä»¶ï¼ŒåŠ è½½ä¸ªäººä¹ æƒ¯çš„é…ç½®ã€‚

ä½¿ç”¨ lldb çš„ **é™„åŠ è¿›ç¨‹** åŠŸèƒ½ï¼ŒæŒ‚è½½ QQ è¿›ç¨‹ä¸Šï¼ˆå¦å¤–ï¼Œä¸ªäººä¹ æƒ¯æŠŠæ±‡ç¼–æŒ‡ä»¤è®¾ç½®ä¸º Intel é£æ ¼ ğŸ˜¶ï¼‰ï¼š

```
lldb --attach-name QQ
(lldb) settings set target.x86-disassembly-flavor intel
```

> ğŸ’¡ å¦‚æœä¸€å¼€å§‹æ²¡æœ‰æ€è·¯ï¼Œå¯ä»¥ä» **ç‰¹æ®Šå‡½æ•°çš„è°ƒç”¨** å°è¯•åˆ‡å…¥ â€”â€” ä¸€èˆ¬çš„ç³»ç»Ÿå‡½æ•°ã€åº“æ¥å£éƒ½æ˜¯ **å¯¼å‡ºå‡½æ•°**ï¼Œå¯ä»¥ç›´æ¥æœåˆ° â€”â€” æ‰€ä»¥èƒŒæ™¯è°ƒç ”çš„æ—¶å€™ï¼Œå°½é‡æŸ¥è¯¢è‹±æ–‡èµ„æ–™ã€‚

é¦–å…ˆï¼Œé€šè¿‡ **æœç´¢ç¬¦å·** `performZoom:`ï¼Œæ‰¾åˆ°å‡½æ•°çš„å…¥å£ï¼š

```
(lldb) im lookup -r -n 'performZoom'
2 matches found in /System/Library/Frameworks/AppKit.framework/Versions/C/AppKit:
        Address: AppKit[0x00007fff22f53cc9] (AppKit.__TEXT.__text + 3586761)
        Summary: AppKit`-[NSWindow performZoom:]
        Address: AppKit[0x00007fff231caccf] (AppKit.__TEXT.__text + 6171343)
        Summary: AppKit`-[NSDrawerWindow performZoom:]
```

éå¸¸å¹¸è¿ï¼Œæ‰¾åˆ°å•¦ï½ è€Œä¸”åªæœ‰ä¸¤ä¸ªç»“æœã€‚

> ğŸ’¡ é€šè¿‡ **è®¾ç½®æ–­ç‚¹+åå¤æ“ä½œ**ï¼Œå°è¯•å®šä½åˆ‡å…¥ç‚¹ã€‚å¦‚æœç»“æœéƒ½ä¸åŒ¹é…ï¼Œå¯ä»¥æœç´¢å…¶ä»–ç¬¦å·ï¼ˆæ¯”å¦‚ `DoubleClick`/`Titlebar`ï¼‰ï¼Œå¹¶å¤šè®¾ç½®ä¸€äº›æ–­ç‚¹ã€‚å¦‚æœè¿˜æ˜¯ä¸åŒ¹é…ï¼Œå¯ä»¥å†æŸ¥æŸ¥èµ„æ–™ï¼Œå¯»æ‰¾æ–°çš„å…³é”®è¯ã€‚

æ¥ç€ï¼Œå…ˆåœ¨å¯èƒ½æ€§æœ€å¤§çš„ `-[NSWindow performZoom:]` **è®¾ç½®æ–­ç‚¹**ï¼š

```
(lldb) b AppKit`-[NSWindow performZoom:]
Breakpoint 1: where = AppKit`-[NSWindow performZoom:], address = 0x00007fff22fb8cc9
```

è¿™æ—¶å€™ï¼Œå°è¯• **åŒå‡»æ ‡é¢˜æ ä¸ŠåŠéƒ¨åˆ†**ï¼Œéå¸¸å¹¸è¿ï¼Œå‘ç°æ¯æ¬¡çª—å£æ”¾ç¼©æ—¶ï¼Œéƒ½ä¼š **ç»è¿‡è¿™ä¸ªå‡½æ•°**ï¼š

```
Process 46732 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
    frame #0: 0x00007fff22fb8cc9 AppKit`-[NSWindow performZoom:]
AppKit`-[NSWindow performZoom:]:
->  0x7fff22fb8cc9 <+0>: push   rbp
    0x7fff22fb8cca <+1>: mov    rbp, rsp
    0x7fff22fb8ccd <+4>: push   r14
    0x7fff22fb8ccf <+6>: push   rbx
Target 0: (QQ) stopped.
```

å†å°è¯• **åŒå‡»æ ‡é¢˜æ ä¸‹åŠéƒ¨åˆ†**ï¼Œå¦‚æˆ‘æ‰€æ–™ï¼Œå‘ç°çª—å£ä¸ä¼šè¿›å…¥æ”¾ç¼©é€»è¾‘ï¼Œä¹Ÿ **ä¸ç»è¿‡è¿™ä¸ªå‡½æ•°**ã€‚å¦å¤–ï¼Œ**è¿›å…¥ã€é€€å‡ºå…¨å±æ¨¡å¼** ä¹Ÿä¸ä¼šè¿›å…¥è¿™ä¸ªå‡½æ•°ã€‚

> ğŸ’¡ æ‰¾åˆ°åˆ‡å…¥ç‚¹åï¼Œæ ¹æ® **è°ƒç”¨å…³ç³»**ï¼Œå¯»æ‰¾ **å¯ç–‘å‡½æ•°**ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ˜æ˜¾ç‰¹å¾ï¼Œå¯ä»¥è§‚å¯Ÿå‡½æ•° åœ¨ä¸åŒæ“ä½œä¸‹çš„è°ƒç”¨å…³ç³»ï¼Œå¯»æ‰¾ **è°ƒç”¨æ ˆçš„å…±åŒéƒ¨åˆ†**ã€‚

æ¥ç€ï¼Œé€šè¿‡ **æŸ¥çœ‹è°ƒç”¨æ ˆ**ï¼Œå‘ç° `AppKit` çš„ç¬¦å·éƒ½å¾ˆå…¨ï¼Œè€Œä¸”å‡½æ•°å‡ ä¹éƒ½èƒ½é¡¾åæ€ä¹‰ ğŸ‘ã€‚è¿™é‡Œçœ‹èµ·æ¥æ˜¯ `NSThemeFrame` å¤„ç†äº† `mouseUp:` äº‹ä»¶ï¼š

```
(lldb) bt
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 4.1
  * frame #0: 0x00007fff22fb8cc9 AppKit`-[NSWindow performZoom:]
    frame #1: 0x00007fff22f1e4b0 AppKit`-[NSTitledFrame _handlePossibleDoubleClickForEvent:] + 216
    frame #2: 0x00007fff22f1df5c AppKit`-[NSThemeFrame mouseUp:] + 278
    ...
```

è¿˜å¯ä»¥æ³¨æ„åˆ° `_handlePossibleDoubleClickForEvent:` åŒ…å«äº†å…³é”®è¯ `DoubleClick`ï¼Œçœ‹ä¼¼ç”¨äºæ§åˆ¶ â€œåŒå‡»æ ‡é¢˜æ  æ”¾ç¼©çª—å£â€ çš„å¤„ç†é€»è¾‘ã€‚

> ğŸ’¡ åå¤ **åˆ‡æ¢æ ˆå¸§**ï¼Œç»“åˆ **åæ±‡ç¼–** ç»“æœï¼Œæ¨æ–­å‡½æ•°çš„ **è°ƒç”¨é€»è¾‘å’Œå…³ç³»**ï¼ŒçŒœæµ‹å‡½æ•°çš„ **æ‰§è¡Œæµç¨‹å’Œæ„å›¾**ã€‚ï¼ˆå½“ç„¶ï¼Œå¦‚æœèƒ½æ‹¿åˆ°ç¬¦å·ï¼Œä¸€å®šè¦å…ˆ **åŠ è½½ç¬¦å·**ï¼›å¦‚æœèƒ½æ‹¿åˆ°æºç ï¼Œä¸€å®šè¦ **é…ç½®æºç è·¯å¾„** â€”â€” ä¸å¿…ç¡¬ç€å¤´çš® è¯»æ±‡ç¼–ä»£ç  ğŸ™ƒï¼‰

äºæ˜¯ï¼Œå…ˆ **åˆ‡æ¢æ ˆå¸§**ï¼Œå† **æŸ¥çœ‹åæ±‡ç¼–**ï¼š

<p><details>
<summary> ğŸ‘‰ ä»£ç æœ‰ç‚¹é•¿ï¼ˆæ…ç‚¹ ğŸ˜‘ï¼‰ğŸ‘ˆ </summary>
<pre><code>
(lldb) up
frame #1: 0x00007fff22f1e4b0 AppKit`-[NSTitledFrame _handlePossibleDoubleClickForEvent:] + 216
AppKit`-[NSTitledFrame _handlePossibleDoubleClickForEvent:]:
->  0x7fff22f1e4b0 <+216>: mov    al, 0x1
    0x7fff22f1e4b2 <+218>: jmp    0x7fff22f1e44c            ; <+116>
(lldb) d
AppKit`-[NSTitledFrame _handlePossibleDoubleClickForEvent:]:
    0x7fff22f1e3d8 <+0>:   push   rbp
    0x7fff22f1e3d9 <+1>:   mov    rbp, rsp
    0x7fff22f1e3dc <+4>:   push   r15
    0x7fff22f1e3de <+6>:   push   r14
    0x7fff22f1e3e0 <+8>:   push   rbx
    0x7fff22f1e3e1 <+9>:   push   rax
    0x7fff22f1e3e2 <+10>:  mov    rbx, rdx
    0x7fff22f1e3e5 <+13>:  mov    r14, rdi
    0x7fff22f1e3e8 <+16>:  mov    rsi, qword ptr [rip + 0x65b8a1f1] ; "clickCount"
    0x7fff22f1e3ef <+23>:  mov    rdi, rdx
    0x7fff22f1e3f2 <+26>:  call   qword ptr [rip + 0x5d65c5f8] ; (void *)0x00007fff20211d00: objc_msgSend
    0x7fff22f1e3f8 <+32>:  cmp    rax, 0x2
    0x7fff22f1e3fc <+36>:  jne    0x7fff22f1e44a            ; <+114>
    0x7fff22f1e3fe <+38>:  mov    rsi, qword ptr [rip + 0x65ba89d3] ; "_eventInTitlebar:"
    0x7fff22f1e405 <+45>:  mov    rdi, r14
    0x7fff22f1e408 <+48>:  mov    rdx, rbx
    0x7fff22f1e40b <+51>:  call   qword ptr [rip + 0x5d65c5df] ; (void *)0x00007fff20211d00: objc_msgSend
    0x7fff22f1e411 <+57>:  test   al, al
    0x7fff22f1e413 <+59>:  je     0x7fff22f1e44a            ; <+114>
    0x7fff22f1e415 <+61>:  mov    rsi, qword ptr [rip + 0x65b840ac] ; "modifierFlags"
    0x7fff22f1e41c <+68>:  mov    rdi, rbx
    0x7fff22f1e41f <+71>:  call   qword ptr [rip + 0x5d65c5cb] ; (void *)0x00007fff20211d00: objc_msgSend
    0x7fff22f1e425 <+77>:  bt     eax, 0x12
    0x7fff22f1e429 <+81>:  jb     0x7fff22f1e44a            ; <+114>
    0x7fff22f1e42b <+83>:  lea    rax, [rip + 0x65bccd4e]   ; NSView._window
    0x7fff22f1e432 <+90>:  mov    r15, qword ptr [rax]
    0x7fff22f1e435 <+93>:  mov    rdi, qword ptr [r14 + r15]
    0x7fff22f1e439 <+97>:  mov    rsi, qword ptr [rip + 0x65b840f8] ; "_isInHiddenWindowTab"
    0x7fff22f1e440 <+104>: call   qword ptr [rip + 0x5d65c5aa] ; (void *)0x00007fff20211d00: objc_msgSend
    0x7fff22f1e446 <+110>: test   al, al
    0x7fff22f1e448 <+112>: je     0x7fff22f1e45a            ; <+130>
    0x7fff22f1e44a <+114>: xor    eax, eax
    0x7fff22f1e44c <+116>: movzx  eax, al
    0x7fff22f1e44f <+119>: add    rsp, 0x8
    0x7fff22f1e453 <+123>: pop    rbx
    0x7fff22f1e454 <+124>: pop    r14
    0x7fff22f1e456 <+126>: pop    r15
    0x7fff22f1e458 <+128>: pop    rbp
    0x7fff22f1e459 <+129>: ret    
    0x7fff22f1e45a <+130>: mov    rdi, qword ptr [r14 + r15]
    0x7fff22f1e45e <+134>: call   0x7fff237e1b4c            ; symbol stub for: objc_opt_class
    0x7fff22f1e463 <+139>: mov    rsi, qword ptr [rip + 0x65ba8976] ; "_shouldZoomOnDoubleClick"
    0x7fff22f1e46a <+146>: mov    rdi, rax
    0x7fff22f1e46d <+149>: call   qword ptr [rip + 0x5d65c57d] ; (void *)0x00007fff20211d00: objc_msgSend
    0x7fff22f1e473 <+155>: test   al, al
    0x7fff22f1e475 <+157>: je     0x7fff22f1e480            ; <+168>
    0x7fff22f1e477 <+159>: mov    rsi, qword ptr [rip + 0x65ba896a] ; "_zoomWindowWithDoubleClick:"
    0x7fff22f1e47e <+166>: jmp    0x7fff22f1e4a4            ; <+204>
    0x7fff22f1e480 <+168>: mov    rdi, qword ptr [r14 + r15]
    0x7fff22f1e484 <+172>: call   0x7fff237e1b4c            ; symbol stub for: objc_opt_class
    0x7fff22f1e489 <+177>: mov    rsi, qword ptr [rip + 0x65ba8960] ; "_shouldMiniaturizeOnDoubleClick"
    0x7fff22f1e490 <+184>: mov    rdi, rax
    0x7fff22f1e493 <+187>: call   qword ptr [rip + 0x5d65c557] ; (void *)0x00007fff20211d00: objc_msgSend
    0x7fff22f1e499 <+193>: test   al, al
    0x7fff22f1e49b <+195>: je     0x7fff22f1e44a            ; <+114>
    0x7fff22f1e49d <+197>: mov    rsi, qword ptr [rip + 0x65ba8954] ; "_minimizeWindowWithDoubleClick:"
    0x7fff22f1e4a4 <+204>: mov    rdi, r14
    0x7fff22f1e4a7 <+207>: mov    rdx, rbx
    0x7fff22f1e4aa <+210>: call   qword ptr [rip + 0x5d65c540] ; (void *)0x00007fff20211d00: objc_msgSend
->  0x7fff22f1e4b0 <+216>: mov    al, 0x1
    0x7fff22f1e4b2 <+218>: jmp    0x7fff22f1e44c            ; <+116>
</code></pre>
</details></p>

æ ¹æ®åæ±‡ç¼–çŸ¥è¯†ï¼ŒçŒœæƒ³ï¼š

- `objc_msgSend` ç”¨äºè°ƒç”¨ Objective-C å¯¹è±¡æ–¹æ³•
  - æ–¹æ³•åé€šè¿‡ `$rsi` ä¼ é€’
  - å¯¹è±¡æŒ‡é’ˆé€šè¿‡ `$rdi` ä¼ é€’
- `_handlePossibleDoubleClickForEvent:` çš„å‰åŠéƒ¨åˆ†åˆ¤æ–­
  - `(NSEvent*)event.clickCount == 2`
  - `[self _eventInTitlebar:event] == YES`
  - `(NSEvent*)event.modifierFlags & 0x12`
  - `[self._window _isInHiddenWindowTab] == NO`
  - å¦‚æœä¸æ»¡è¶³ä¸Šè¿° 4 ä¸ªæ¡ä»¶ï¼Œç›´æ¥ `jmp 0x7fff22f1e44a`ï¼Œè·³è¿‡åç»­é€»è¾‘
  - åªæœ‰æ»¡è¶³äº†ä¸Šè¿° 4 ä¸ªæ¡ä»¶ï¼Œæ‰èƒ½ `jmp 0x7fff22f1e45a`ï¼Œè¿›å…¥åç»­é€»è¾‘
- `_handlePossibleDoubleClickForEvent:` çš„ååŠéƒ¨åˆ†ï¼Œæ ¹æ®ç³»ç»Ÿè®¾ç½®ï¼Œé€‰æ‹© **æ”¾ç¼©çª—å£** æˆ– **æœ€å°åŒ–çª—å£**ï¼ˆå†æ¬¡ [å‚è€ƒç½‘å‹çš„å›ç­”](https://apple.stackexchange.com/questions/95681/how-can-i-change-os-x-double-click-on-title-bar-to-be-like-windows/232153#232153)ï¼‰
  - **æ—§ç‰ˆ macOS ç³»ç»Ÿ** åŒå‡»æ ‡é¢˜æ çš„äº¤äº’é€»è¾‘æ˜¯ **æœ€å°åŒ–çª—å£**ï¼ˆè®© Windows ç”¨æˆ·æŠ“ç‹‚ ğŸ˜«ï¼‰
  - **æ–°ç‰ˆ macOS ç³»ç»Ÿ** æ”¯æŒä¸Šè¿°ä¸¤ç§è¡Œä¸ºï¼ˆé»˜è®¤æ˜¯ **æ”¾ç¼©çª—å£**ï¼‰

å¤§å®¶å¯èƒ½ä¼šé—®ï¼šè°ƒç”¨æ ˆä¸Šä¸ºä»€ä¹ˆæ²¡æœ‰å‡ºç° `_zoomWindowWithDoubleClick:`ï¼Ÿçœ‹ä¸Šå»æ˜¯ç›´æ¥è°ƒç”¨äº† `performZoom:` å‡½æ•°ã€‚è¿™æ˜¯å› ä¸ºï¼š

- `_zoomWindowWithDoubleClick:` å†…éƒ¨ä½¿ç”¨äº† **æ ˆå¸§æŒ‡é’ˆçœç•¥** _(frame pointer omission, FPO)_ ä¼˜åŒ–
- ç›´æ¥ç”¨ `jmp` æŒ‡ä»¤ä»£æ›¿ `call` æŒ‡ä»¤è°ƒç”¨ `performZoom:` å‡½æ•°ï¼Œä¸ä¼šæ„é€ æ–°çš„æ ˆå¸§

> ğŸ’¡ é€šè¿‡ **å•æ­¥è°ƒè¯•** è·Ÿè¸ªè°ƒç”¨æµç¨‹ï¼Œæ‰¾åˆ°å‡ºç° **æ‰§è¡Œè·¯å¾„åˆ†æ­§** çš„ä½ç½®ã€‚è¿˜å¯ä»¥ **å•æ­¥è¿›å…¥å‡½æ•°**ï¼Œè·Ÿè¸ªå­å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œåˆ†æå‡ºç° **åˆ†æ­§çš„åŸå› **ã€‚

ä¸ºäº†éªŒè¯çŒœæƒ³ï¼Œå¯ä»¥å†æ¬¡ **è®¾ç½®æ–­ç‚¹**ï¼š

```
(lldb) b AppKit`-[NSTitledFrame _handlePossibleDoubleClickForEvent:]
Breakpoint 2: where = AppKit`-[NSTitledFrame _handlePossibleDoubleClickForEvent:], address = 0x00007fff22f1e3d8
```

ç„¶åï¼Œå°è¯• **ç‚¹å‡»æ ‡é¢˜æ ä»»æ„éƒ¨åˆ†**ï¼ˆåŒ…æ‹¬å•å‡»ã€åŒå‡»ï¼‰ï¼Œéå¸¸å¹¸è¿ï¼Œå‘ç°æ— è®ºçª—å£æ˜¯å¦æ”¾ç¼©ï¼Œéƒ½ä¼š **ç»è¿‡è¿™ä¸ªå‡½æ•°**ã€‚å¦å¤–ï¼Œç‚¹å‡»ç•Œé¢ä¸Šçš„å…¶ä»–åŒºåŸŸï¼Œä¸ä¼šè¿›å…¥è¿™ä¸ªå‡½æ•°ã€‚

æ¥ç€ï¼Œåˆ©ç”¨ **å•æ­¥è°ƒè¯•**ï¼Œå¯ä»¥å‘ç°ï¼šåœ¨åŒå‡»ï¼ˆå³ `event.clickCount == 2`ï¼‰çš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨ `_eventInTitlebar:` åï¼Œåœ¨ `0x7fff22f1e411` æ£€æŸ¥è¿”å›å€¼ `$al`ï¼Œå‡ºç°äº†åˆ†æ­§ï¼š

- åŒå‡»æ ‡é¢˜æ ä¸ŠåŠéƒ¨åˆ†ï¼Œ`$al` ä¸º `0x01`ï¼Œè¿›å…¥æ”¾ç¼©é€»è¾‘
- åŒå‡»æ ‡é¢˜æ ä¸‹åŠéƒ¨åˆ†ï¼Œ`$al` ä¸º `0x00`ï¼Œè·³è¿‡æ”¾ç¼©é€»è¾‘

> ğŸ’¡ åˆ©ç”¨ **æ–­ç‚¹å‘½ä»¤** è¾“å‡ºæ—¥å¿—ã€éä¾µå…¥å¼çš„ä¿®æ”¹è¿è¡ŒçŠ¶æ€ï¼Œå†ç»“åˆ **åå¤æ“ä½œ**ï¼Œè§‚å¯ŸçŠ¶æ€å˜åŒ–çš„å¼‚åŒç‚¹ï¼Œ**éªŒè¯** ä¹‹å‰çš„çŒœæƒ³ã€‚

ä¸ºäº†è¿›ä¸€æ­¥éªŒè¯çŒœæƒ³ï¼Œä½¿ç”¨ **æ–­ç‚¹å‘½ä»¤** æ‰“å° `_eventInTitlebar:` çš„è¿”å›å€¼ `$al`ï¼Œå¹¶ç«‹å³ **ç»§ç»­æ‰§è¡Œ**ï¼š

```
(lldb) br disable 1 2
2 breakpoints disabled.
(lldb) b 0x7fff22f1e411
Breakpoint 3: where = AppKit`-[NSTitledFrame _handlePossibleDoubleClickForEvent:] + 57, address = 0x00007fff22f1e411
(lldb) br command add 3
Enter your debugger command(s).  Type 'DONE' to end.
> re r al 
> c 
> DONE
```

ç»è¿‡åå¤è§‚å¯Ÿï¼Œå¯ä»¥å‘ç°ï¼šåœ¨åŒå‡»æ ‡é¢˜æ çš„ä¸ŠåŠéƒ¨åˆ†å’Œä¸‹åŠéƒ¨åˆ†æ—¶ï¼Œ`_eventInTitlebar:` åˆ†åˆ«è¿”å› `0x01` å’Œ `0x00`ï¼Œç¬¦åˆé¢„æœŸã€‚

æœ€åï¼Œå¯ä»¥é‡æ–°è®¾ç½® **æ–­ç‚¹å‘½ä»¤**ï¼Œè®© `_eventInTitlebar:` æ€»æ˜¯è¿”å› `0x01`ï¼Œè¿™æ ·å°± **ä¸´æ—¶è§£å†³** äº†è¿™ä¸ªçƒ¦äººçš„é—®é¢˜ï¼š

```
(lldb) br command add 3
Enter your debugger command(s).  Type 'DONE' to end.
> re w al 0x01 
> c 
> DONE
```

ç”±äºè¿›ç¨‹ä½¿ç”¨äº† **åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–** _(address space layout randomization, ASLR)_ï¼ŒåŒä¸€æ¨¡å—é‡Œçš„åŒä¸€æŒ‡ä»¤ åœ¨å†…å­˜ä¸­çš„ **å®é™…åœ°å€**ï¼ˆä¾‹å¦‚è¿™æ¬¡æ˜¯ `0x7fff22f1e411`ï¼‰åœ¨ä¸åŒè¿›ç¨‹ä¸­ **å¯èƒ½ä¸åŒ**ï¼ˆæ¯æ¬¡è¿è¡Œéƒ½æ˜¯ä¸åŒè¿›ç¨‹ï¼‰ï¼Œä½†ç›¸å¯¹äºå‡½æ•°çš„ **åç§»é‡æ˜¯ä¸å˜çš„**ï¼ˆä¾‹å¦‚æ­¤å¤„æ˜¯ `+ 57`ï¼‰ã€‚

æ‰€ä»¥ï¼Œé’ˆå¯¹åŒå‡»æ ‡é¢˜æ æ— æ³•æ”¾ç¼©çš„é—®é¢˜ï¼Œä¸è®ºæ˜¯ QQ è¿˜æ˜¯å…¶ä»–è½¯ä»¶ï¼Œéƒ½å¯ä»¥ â€œå€ŸåŠ© **æŒ‡ä»¤åç§»é‡** è®¾ç½®æ–­ç‚¹ã€æ·»åŠ  **æ–­ç‚¹å‘½ä»¤**ã€å† **ç»§ç»­æ‰§è¡Œ**â€ çš„æ–¹æ³•è§£å†³ï¼š

```
(lldb) br set -n '-[NSTitledFrame _handlePossibleDoubleClickForEvent:]' -R 57 -C 're w al 0x01' -G true
```

> ğŸ‘€ ç»™å¤§å®¶ç•™ä¸ªæ€è€ƒé¢˜ â€”â€”

å¦‚ä½• **å½»åº•è§£å†³** è¿™ä¸ªé—®é¢˜ï¼Ÿéš¾ç‚¹åœ¨äºï¼š

- ç”±äº `_handlePossibleDoubleClickForEvent:` å’Œ `_eventInTitlebar:` æ˜¯ `AppKit` é‡Œçš„ç¬¦å·ï¼Œæ”¾åœ¨ç³»ç»Ÿç›®å½•ï¼Œä¸èƒ½ç›´æ¥ä¿®æ”¹é‡Œè¾¹çš„ä»£ç ï¼ˆå³ä½¿ä¿®æ”¹äº†ï¼Œä¹Ÿä¼šå¸¦æ¥å…¶ä»–é£é™©ï¼‰
- æ‰€ä»¥ï¼Œæˆ‘ä»¬åªèƒ½ä¿®æ”¹è½¯ä»¶æœ¬èº«çš„ä»£ç ï¼›ä½†è¿™äº›ä»£ç æ²¡æœ‰ç¬¦å·ï¼ˆå½“ç„¶ä¸ä¼šå…¬å¼€ï¼‰ï¼Œéš¾ä»¥å®šä½åˆ‡å…¥ç‚¹
- å¦‚æœä½ æœ‰æƒ³æ³•ï¼Œ**æ¬¢è¿åœ¨æ–‡ç« ä¸‹æ–¹ç•™è¨€**ï¼ˆæŠ“ç´§æ—¶é—´ï¼Œè¯´ä¸å®š[ä¸‹ä¸€ä¸ªç‰ˆæœ¬ QQ](https://im.qq.com/macqq/) å°±ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ ğŸ™ƒï¼‰

## è°ƒè¯•æ— å¤„ä¸åœ¨

> æ­£æ–‡å¼€å§‹ ğŸ™ƒ

### ä¸è°ƒè¯•å™¨å…±èˆ

å†™å®Œè¿™ä¸ªå°èŠ‚åï¼Œå¶ç„¶è¯»åˆ°ä¸€ç¯‡å…³äºè°ƒè¯•çš„æ–‡ç« ï¼š[Dancing in the Debugger â€” A Waltz with LLDB](https://www.objc.io/issues/19-debugging/lldb-debugging/) by _Ari Grant_ï¼ˆè¯‘æ–‡ï¼š[ä¸è°ƒè¯•å™¨å…±èˆ - LLDB çš„åå°”å…¹](https://objccn.io/issue-19-2/)ï¼‰ã€‚äºæ˜¯ï¼Œæˆ‘å†³å®šåˆ å‡è¿™ä¸ªå°èŠ‚ï¼Œå¹¶ **æ¨èè¿™ç¯‡æ–‡ç« **ï¼ˆè™½ç„¶è®²çš„æ˜¯ Objective-C å’Œ macos/iOS çš„å†…å®¹ï¼Œä½†æ˜¯æ€è·¯å€¼å¾—å€Ÿé‰´ï¼‰ï¼š

> ä½ æ˜¯å¦æ›¾ç»è‹¦æ¼äºç†è§£ä»£ç ï¼Œè€Œå»å°è¯•æ‰“å°ä¸€ä¸ªå˜é‡çš„å€¼ï¼Ÿ
> 
> ``` objc
> NSLog(@"%@", whatIsInsideThisThing);
> ```
> 
> æˆ–è€…è·³è¿‡ä¸€ä¸ªå‡½æ•°è°ƒç”¨æ¥ç®€åŒ–ç¨‹åºçš„è¡Œä¸ºï¼Ÿ
> 
> ``` objc
> NSNumber *n = @7;  // å®é™…åº”è¯¥è°ƒç”¨ Foo()ï¼Œè¿™é‡Œæ³¨é‡Šæ‰
> ```
> 
> æˆ–è€…çŸ­è·¯ä¸€ä¸ªé€»è¾‘æ£€æŸ¥ï¼Ÿ
> 
> ``` objc
> if (1 || theBooleanAtStake) { ... }
> ```
> 
> æˆ–è€…ä¼ªé€ ä¸€ä¸ªå‡½æ•°å®ç°ï¼Ÿ
> 
> ``` objc
> int calculateTheTrickyValue {
>   return 9;
>   /*
>    åè¾¹å†çœ‹çœ‹åœ¨å“ªå‡ºäº†é—®é¢˜
>    ...
>   */
> }
> ```
> 
> å¹¶ä¸”æ¯æ¬¡å¿…é¡»é‡æ–°ç¼–è¯‘ï¼Œç„¶åä»å¤´å¼€å§‹ï¼Ÿ

åˆšå­¦ä¹ ç¼–ç¨‹çš„æ—¶å€™ï¼Œå¤šæ•°äººï¼ˆåŒ…æ‹¬æˆ‘ï¼‰è¿˜ä¸ä¼šä½¿ç”¨è°ƒè¯•å™¨ï¼Œå°±è¿™æ ·è°ƒè¯•ä»£ç ã€‚ç„¶è€Œï¼Œç°åœ¨å‘¨å›´è¿˜æœ‰å¾ˆå¤šäººåœ¨ç”¨è¿™ç§ â€œåŸå§‹çš„æ–¹æ³•â€ æ’æŸ¥é—®é¢˜ ğŸ™„

ä¹‹å‰æœ‰ä¸€ä½åŒäº‹å°±å’Œæˆ‘åæ§½ï¼Œç”¨ Python å¼€å‘æœåŠ¡æ•ˆç‡æ¯” C++ é«˜å¾ˆå¤šï¼š

- å…¶ä¸­ä¸€ä¸ªåŸå› æ˜¯ Python æœåŠ¡åœ¨æœåŠ¡å™¨ä¸Šä¿®æ”¹ä»£ç åï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€éªŒè¯
- ç„¶è€Œ C++ æœåŠ¡æ¯æ¬¡ æ”¹äº†ä¸€ä¸ªå‚æ•° æˆ–è€… åŠ äº†ä¸¤è¡Œæ—¥å¿—ï¼Œå°±è¦é‡æ–° **ç¼–è¯‘ã€æ‰“åŒ…ã€éƒ¨ç½²ã€è¿è¡Œ**ï¼ˆç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥å–æ¯æ°´ã€åˆ·åˆ·æ‰‹æœºï¼‰
- å¦‚æœå‘ç°åˆšåˆš æ”¹çš„å‚æ•°ä¸å¯¹ æˆ–è€… åŠ çš„æ—¥å¿—ä¸å¤Ÿç”¨ï¼Œè¿˜å¾— **å†æ¥ä¸€é**ï¼ˆåˆå¯ä»¥å†å–æ¯æ°´ã€ç»§ç»­åˆ·ä¸€ä¼šå„¿æ‰‹æœºï¼‰

äºæ˜¯æˆ‘å‘Šè¯‰ä»–ï¼Œå¯ä»¥ä½¿ç”¨ **è°ƒè¯•å™¨** æ’æŸ¥ C++ æœåŠ¡çš„é—®é¢˜ï¼šç°ä»£è°ƒè¯•å™¨ä¸€èˆ¬éƒ½æ”¯æŒ **æ–­ç‚¹å‘½ä»¤**ï¼ˆå‘½ä¸­æ–­ç‚¹åï¼Œå¯ä»¥æ‰§è¡Œè°ƒè¯•å™¨å‘½ä»¤ï¼‰å’Œ **æ¡ä»¶æ–­ç‚¹**ï¼ˆåªæœ‰æ»¡è¶³ç‰¹å®šæ¡ä»¶ï¼Œæ‰ä¼šå‘½ä¸­æ–­ç‚¹ï¼‰ï¼›ç”¨è°ƒè¯•å™¨ **é™„åŠ è¿›ç¨‹** åï¼Œé…åˆè¿™ä¸¤ä¸ªåŠŸèƒ½ï¼Œæ¯”ä¸€èˆ¬çš„æ—¥å¿—è¾“å‡ºåŠŸèƒ½ **æ›´å¼ºå¤§** â€”â€”

- é™¤äº†æ‰“å°å˜é‡çš„å€¼ï¼Œè¿˜å¯ä»¥æ‰“å° è°ƒç”¨æ ˆã€å¯„å­˜å™¨ã€å†…å­˜ ç­‰ **åŸå§‹çŠ¶æ€**
- å¦å¤–ï¼Œè¿˜å¯ä»¥ç›´æ¥ä¿®æ”¹ å˜é‡ã€å¯„å­˜å™¨ã€å†…å­˜ çš„çŠ¶æ€ï¼Œ**æ§åˆ¶æ‰§è¡Œæµç¨‹**
- å…³é”®åœ¨äºï¼Œä¸Šè¿°æ“ä½œ **æ— éœ€ä¿®æ”¹ä»£ç **

è¿™ä½åŒäº‹ç”¨ä¸Šè°ƒè¯•å™¨ä¸€æ®µæ—¶é—´åï¼Œå‘æˆ‘ â€œè¯‰è‹¦â€ï¼šâ€œæ‘¸é±¼â€ çš„æœºä¼šå˜å°‘äº† ğŸ™ƒ

### èä¼šè´¯é€š

å°½ç®¡ä¸åŒè°ƒè¯•å™¨çš„ç”¨æ³•ä¸åŒï¼Œä½†åŸç†éƒ½æ˜¯ç›¸ä¼¼çš„ã€‚è¿™ä¸ªå°èŠ‚æ€»ç»“äº†å¸¸ç”¨å‘½ä»¤çš„ä¸€äº›ä½¿ç”¨åœºæ™¯ã€‚

**æœç´¢ç¬¦å·**ï¼š

- æœç´¢ **å‡½æ•°å…¥å£**ï¼Œå¯ä»¥ç”¨äºè®¾ç½®æ–­ç‚¹
- **åˆ—ä¸¾æ¨¡å—**ï¼ŒæŸ¥çœ‹è¿›ç¨‹åŠ è½½äº†å“ªäº›æ¨¡å—ï¼ŒåŠå…¶å†…å­˜åœ°å€èŒƒå›´

**æ–­ç‚¹**ï¼š

- æ‰§è¡Œåˆ°ç‰¹å®šçš„ **å‡½æ•°** æˆ–å‡½æ•°ä¸­çš„æŸä¸ª **æ­¥éª¤** æ—¶ï¼Œ**æš‚åœè¿›ç¨‹**
- è¿›ç¨‹æš‚åœåï¼Œå¯ä»¥è¯»å–/ä¿®æ”¹ **å˜é‡ã€å¯„å­˜å™¨ã€å†…å­˜** çš„çŠ¶æ€

**ç›‘è§†ç‚¹**ï¼š

- è®¿é—®ç‰¹å®š **å†…å­˜ä½ç½®** æ—¶ï¼Œ**æš‚åœè¿›ç¨‹**
- ç”¨äºè§‚å¯Ÿ **éæ ˆä¸Šçš„å˜é‡** çš„è®¿é—®æƒ…å†µã€å¼•ç”¨å…³ç³»ï¼ˆæ ˆä¸Šå˜é‡å¯ä»¥åˆ©ç”¨ **å•æ­¥è°ƒè¯•** è§‚å¯Ÿï¼‰
- éœ€è¦æ³¨æ„ å˜é‡çš„å†…å­˜åœ°å€ æ˜¯ è¿è¡Œæ—¶åŠ¨æ€åˆ†é… çš„

**æ–­ç‚¹/ç›‘è§†ç‚¹ å‘½ä»¤**ï¼š

- å‘½ä¸­æ–­ç‚¹/ç›‘è§†ç‚¹å **æ‰§è¡Œå‘½ä»¤**
- ä¸€ä¸ªæŠ€å·§æ˜¯ï¼šå…ˆè¯»å–/ä¿®æ”¹ **å˜é‡ã€å¯„å­˜å™¨ã€å†…å­˜** çŠ¶æ€ï¼Œå†ç«‹å³ **ç»§ç»­æ‰§è¡Œ** â€”â€” ä»è€Œå®ç°äº† æ‰“å°æ—¥å¿—ã€æ§åˆ¶æ‰§è¡Œæµç¨‹ çš„åŠŸèƒ½
- é€šè¿‡ä¿®æ”¹è¿”å›å€¼ï¼Œå¯ä»¥ **è‡ªå®šä¹‰è·³è½¬** é€»è¾‘
  - å¦‚æœæœ‰ç¬¦å·ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ `thread return` ç­‰å‘½ä»¤
  - å¦‚æœæ— ç¬¦å·ï¼Œå¯ä»¥å…ˆä¿®æ”¹è¿”å›å€¼ï¼Œå†ä½¿ç”¨ `jump` ç­‰å‘½ä»¤

**æ¡ä»¶ æ–­ç‚¹/ç›‘è§†ç‚¹**ï¼š

- **æŒ‰éœ€** å‘½ä¸­æ–­ç‚¹/ç›‘è§†ç‚¹
- å®ç°äº† `if(condition) ä¸­æ–­; else ç»§ç»­æ‰§è¡Œ;` çš„åŠŸèƒ½
- é…åˆ **æ–­ç‚¹/ç›‘è§†ç‚¹ å‘½ä»¤**ï¼Œå¯ä»¥å®ç° **æ¡ä»¶è·³è½¬**

**è°ƒç”¨æ ˆ**ï¼š

- è¿›ç¨‹æš‚åœåï¼ŒæŸ¥çœ‹ï¼ˆæ‰€æœ‰çº¿ç¨‹çš„ï¼‰**å‡½æ•°è°ƒç”¨å…³ç³»**
- **åˆ‡æ¢æ ˆå¸§**ï¼ŒæŸ¥çœ‹ ä¸åŒå‡½æ•° é‡Œçš„ å˜é‡å€¼ï¼ˆå¯„å­˜å™¨ ä¸ä¼šåˆ‡æ¢ï¼‰
- **åˆ‡æ¢çº¿ç¨‹**ï¼ŒæŸ¥çœ‹ ä¸åŒçº¿ç¨‹ é‡Œçš„ è°ƒç”¨æ ˆï¼ˆå¯„å­˜å™¨ éšä¹‹åˆ‡æ¢ï¼‰

**å•æ­¥è°ƒè¯•**ï¼š

- **åŠ¨æ€** è§‚å¯Ÿå‡½æ•°çš„ **æ‰§è¡Œæµç¨‹**
- step-over è·Ÿè¸ª **å‡½æ•°å†…éƒ¨** çš„æ‰§è¡Œæµç¨‹
- step-in/out è·Ÿè¸ª **å‡½æ•°ä¹‹é—´** çš„è°ƒç”¨å…³ç³»
- stop-hook åœ¨æ¯æ¬¡æš‚åœæ—¶ æ‰§è¡Œå‘½ä»¤ï¼ˆä¾‹å¦‚ `display`/`watch` æ‰“å°å˜é‡ï¼‰

**åæ±‡ç¼–**ï¼š

- **é™æ€** é˜…è¯»å‡½æ•°çš„ **æ‰§è¡Œæµç¨‹**
- å»ºè®®ä¼˜å…ˆ **åŠ è½½ç¬¦å·** å¹¶ **é…ç½®æºç è·¯å¾„**ï¼Œè€Œä¸åªæ˜¯çœ‹åæ±‡ç¼–
- å¦‚æœæºç ç»è¿‡ä¼˜åŒ–ï¼ˆä¾‹å¦‚ **å†…è”** _(inline)_ æˆ–ä¸Šæ–‡æåˆ°çš„ _FPO_ï¼‰ï¼Œå»ºè®®ä¼˜å…ˆæŸ¥çœ‹åæ±‡ç¼–ï¼ˆæ‰€ä»¥å¾ˆå¤šå›¢é˜Ÿä¸å…è®¸ä½¿ç”¨ `-O3`ï¼‰

**å†…å­˜æœç´¢**ï¼š

- åœ¨å†…å­˜ä¸­æŸ¥æ‰¾ ç‰¹å®šå­—èŠ‚ï¼ˆä½†ç»“æœä¸­å­˜åœ¨å¹²æ‰°ï¼Œä¸å¦‚æ–­ç‚¹å¥½ç”¨ï¼‰
- **æœç´¢å­—ç¬¦ä¸²**ï¼Œç”¨äºå¯»æ‰¾ éæ ˆä¸Šçš„å˜é‡ çš„ä½ç½®ï¼ˆéœ€è¦åŒºåˆ† `char`/`wchar_t`ï¼‰
- **æœç´¢è™šå‡½æ•°è¡¨æŒ‡é’ˆ**ï¼Œç”¨äºæŸ¥æ‰¾ç‰¹å®šå¯¹è±¡çš„ æ‰€æœ‰å®ä¾‹ï¼ˆå¦‚æœæ˜¯å•ä¾‹ï¼Œä¼šç®€å•ä¸€äº›ï¼‰
- å¼ºçƒˆæ¨è å¼ é“¶å¥çš„[ã€Šä»å †é‡Œå¯»æ‰¾ä¸¢å¤±çš„æ•°æ®ã€‹](http://advdbg.org/blogs/advdbg_system/articles/3413.aspx)

**æ‰§è¡Œè„šæœ¬**ï¼š

- åˆ©ç”¨ Python è„šæœ¬ï¼Œå®ç° **å¤æ‚åŠŸèƒ½**
- ä¾‹å¦‚ é…ç½®ç‰¹å®š C++ æ•°æ®ç±»å‹çš„ **æ‰“å°æ ¼å¼**

æœ€åï¼Œæ›´å¤šç»†èŠ‚æ¨èé˜…è¯»ï¼š

- ã€ŠC++ åæ±‡ç¼–ä¸é€†å‘åˆ†ææŠ€æœ¯æ­ç§˜ã€‹é’±æ—æ¾ èµµæµ·æ—­
- ã€Šè½¯ä»¶è°ƒè¯•ã€‹å¼ é“¶å¥

### è¾…åŠ©å·¥å…·

é™¤äº†ä½¿ç”¨è°ƒè¯•å™¨ï¼Œè¿˜å¯ä»¥å€ŸåŠ© **å·¥å…·** è§‚å¯Ÿç¨‹åºè¡Œä¸ºï¼Œå†æŒ‚ä¸Šè°ƒè¯•å™¨ **å¯¹ç—‡ä¸‹æ–­ç‚¹**ã€‚è¿™ä¸ªå°èŠ‚åˆ†äº«å‡ ä¸ª Windows ä¸Šçš„ä¾‹å­ï¼ˆé¡ºä¾¿æ€€å¿µä¸€ä¸‹ä½¿ç”¨ Windows åŠå…¬çš„æ—¶å…‰ ğŸ˜¶ï¼‰ã€‚

**æ‰¾ä¸åˆ° DLL**ï¼š

> ğŸ’¡ [Process Monitor](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon) å¯ä»¥ç›‘æ§è¿›ç¨‹çš„ **æ³¨å†Œè¡¨æ“ä½œã€æ–‡ä»¶ I/Oã€ç½‘ç»œ I/Oã€çº¿ç¨‹æ´»åŠ¨** ç­‰è¡Œä¸ºï¼Œå¹¶è®°å½•æ¯ä¸ªè¡Œä¸ºå¯¹åº”çš„ **è°ƒç”¨æ ˆ**ï¼Œè¿˜æ”¯æŒ **åŠ è½½ç¬¦å·**ã€‚

åˆšè£…ä¸Šçš„ lldb æ— æ³•è¿è¡Œï¼Œè£…äº† Python 3.6 ä¹Ÿä¸è¡Œï¼š

[img=border:outset]

![Windows-Dll-Not-Found](Debug-Everywhere/Windows-Dll-Not-Found.png)

æ ¹æ®æ–‡ä»¶ I/O è®°å½•ï¼Œå‘ç° Python 3.6 ä¸åœ¨è·¯å¾„çš„æœç´¢èŒƒå›´å†…ï¼›ç”±æ­¤å¯ä»¥æ¨æ–­æ˜¯ç¯å¢ƒå˜é‡ `%PATH%` çš„é…ç½®é—®é¢˜ï¼š

[img=border:outset]

![Windows-Procmon](Debug-Everywhere/Windows-Procmon.png)

è¿˜æœ‰ä¸€æ¬¡ï¼Œå€ŸåŠ©è¿™ä¸ªå·¥å…·ï¼Œé€†å‘åˆ†æäº†æŸå®¢æˆ·ç«¯çš„å´©æºƒé—®é¢˜ï¼š

- å¦‚æœç”¨æˆ·ååŒ…å«ä¸­æ–‡ï¼Œåœ¨è®¿é—® `%appdata%` æ—¶ï¼Œä¼ å…¥äº† **ç¼–ç é”™è¯¯çš„å­—ç¬¦ä¸²**ï¼Œå¯¼è‡´è®¿é—®å¤±è´¥
- è€Œè¯¥å®¢æˆ·ç«¯çš„åç»­é€»è¾‘ï¼Œæ²¡æœ‰è€ƒè™‘åˆ° `CreateFile()` è°ƒç”¨å¤±è´¥çš„æƒ…å†µï¼Œä»è€Œå¯¼è‡´å´©æºƒ ğŸ˜¶

å¦å¤–ï¼Œè¿™ä¸ªå·¥å…·è¿˜èƒ½ç”¨äº è§‚å¯ŸæŸäº›åå°è¿›ç¨‹æ˜¯ä¸æ˜¯åœ¨ â€œå¹²åäº‹â€ ğŸ™„ï¼ˆæ¨èé˜…è¯»ï¼š[ã€Šå…³äº QQ è¯»å– Chrome å†å²è®°å½•çš„æ¾„æ¸…ã€‹](https://bbs.pediy.com/thread-265359.htm) by _qwqdanchun_ï¼‰

**æ–‡ä»¶è¢«å ç”¨**ï¼š

> ğŸ’¡ [Process Explorer](https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer) å¯ä»¥åˆ—ä¸¾æ‰€æœ‰è¿›ç¨‹çš„ **çˆ¶å­å…³ç³»ã€æ‰“å¼€çš„å¥æŸ„ã€åŠ è½½çš„æ¨¡å—ã€èµ„æºå ç”¨ã€è¿è¡Œå‚æ•°** ç­‰ä¿¡æ¯ï¼Œå¯ç”¨äºæ›¿æ¢ ç³»ç»Ÿè‡ªå¸¦çš„ä»»åŠ¡ç®¡ç†å™¨ã€‚

æ¯å½“åˆ é™¤æ–‡ä»¶æˆ–ç›®å½•æ—¶ï¼Œå¸¸ä¼šå‘ç°è¢«æŸäº›ç¨‹åºå ç”¨ï¼š

[img=border:outset]

![Windows-File-In-Use](Debug-Everywhere/Windows-File-In-Use.png)

é€šè¿‡æœç´¢ï¼Œå‘ç°è¯¥ç›®å½•é‡Œçš„ `ruby.exe` æ­£åœ¨è¿è¡Œï¼Œç›®å½•é‡Œçš„ä¸€äº› DLL è¢«åŠ è½½ï¼š

[img=border:outset]

![Windows-Procexp](Debug-Everywhere/Windows-Procexp.png)

**æœªçŸ¥å¼¹çª—**ï¼š

> ğŸ’¡ [Process Explorer](https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer) è¿˜æ”¯æŒé€šè¿‡ **çª—å£å¥æŸ„** æœç´¢è¿›ç¨‹ï¼Œå¯ç”¨äºå®šä½çª—å£æ‰€åœ¨è¿›ç¨‹ã€‚ï¼ˆæœ€è¿‘çœ‹åˆ° macOS ä¸Šæœ‰ä¸ª [SonOfGrab](https://developer.apple.com/library/archive/samplecode/SonOfGrab/Introduction/Intro.html) ä¹Ÿæ”¯æŒç±»ä¼¼åŠŸèƒ½ï¼‰

å½“ä½ çªç„¶çœ‹åˆ°ä¸€ä¸ªå¼¹çª—ï¼Œéœ€è¦ **å…ˆç¡®å®šæ˜¯å“ªä¸ªè¿›ç¨‹** å¼¹å‡ºçš„ï¼Œç„¶åæ‰èƒ½æŒ‚ä¸Šè°ƒè¯•å™¨ã€‚

å…·ä½“æ¡ˆä¾‹éå¸¸å¤šï¼Œå¦‚æœä½ è£…äº†æŸè¾“å…¥æ³•ï¼Œå³ä¸‹è§’æ€»ä¼šå¼¹å‡ºå„ç§å¥‡æ€ªçš„å°çª— ğŸ™ˆ

**åˆ†æå´©æºƒ**ï¼š

> ğŸ’¡ Dump æ–‡ä»¶å°±åƒç…§ç‰‡ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½å¯èƒ½è®©æˆ‘ä»¬æƒ³èµ·ä¸€æ®µæ•…äº‹ï¼Œæ—¶é—´è¶Šé•¿ï¼Œè¶Šå€¼å¾—å›å‘³ã€‚â€”â€”ã€Šæ ¼è ¹æ±‡ç¼–ã€‹å¼ é“¶å¥

è°ƒè¯•å™¨é™¤äº†å¯ä»¥ç”¨äºè°ƒè¯•ç¨‹åºï¼Œè¿˜èƒ½ç”¨äºåˆ†æå´©æºƒ **è½¬å‚¨** _(dump)_ æ–‡ä»¶ã€‚

å¾ˆå¤šäººæ‹¿åˆ°ä¸€ä¸ª dump æ–‡ä»¶ï¼Œåªçœ‹å´©æºƒæ—¶çš„è°ƒç”¨æ ˆï¼Œè€Œå¿½ç•¥äº†ä¸°å¯Œçš„ å¯„å­˜å™¨ã€å†…å­˜ã€çº¿ç¨‹ ç­‰ä¿¡æ¯ï¼›è€Œè¿™äº›æ•°æ®å¾€å¾€æ˜¯ æ’æŸ¥é—®é¢˜çš„å…³é”® â€”â€”

- å¦‚æœæ•´ä¸ª dump æ–‡ä»¶æ˜¯ä¸€å¼  â€œæ¡ˆå‘ç°åœºâ€ çš„ä¸€äº¿åƒç´ ç…§ç‰‡
- é‚£ä¹ˆ å´©æºƒçº¿ç¨‹çš„è°ƒç”¨æ ˆ åªæ˜¯å®ƒçš„ 32kb ç¼©ç•¥å›¾ 

å€ŸåŠ© dump æ–‡ä»¶çš„ä¸°å¯Œä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ **å˜é‡ã€å¯„å­˜å™¨ã€å†…å­˜** çš„çŠ¶æ€ï¼Œè®©ç¨‹åºè¿›å…¥ **é¢„æœŸçš„åˆ†æ”¯**ï¼Œè¿˜åŸå´©æºƒå‰çš„åœºæ™¯ï¼Œå¤ç°ä¸€äº›éš¾ä»¥å¤ç°çš„é—®é¢˜ â€”â€” é™æ€åˆ†æå´©æºƒçŠ¶æ€ + åŠ¨æ€åˆ†ææ‰§è¡Œæµç¨‹ = æ•ˆç‡æ›´é«˜ ğŸ˜

æœ€ååˆ†äº«ä¸€ä¸ª **æ— çº¿ç½‘å¡é©±åŠ¨ è“å±å´©æºƒ** çš„è§£å†³æ–¹æ¡ˆï¼š

<p><details>
<summary> ğŸ‘‰ æˆªå›¾è¾ƒé•¿ï¼Œç‚¹å‡»å±•å¼€ ğŸ‘ˆ </summary>
<img src="Debug-Everywhere/Windows-Blue-Screen.jpg"
     alt="Windows-Blue-Screen" style="border:solid thin" />
</details></p>

å…³äºå´©æºƒçš„è¯é¢˜ï¼Œä¸‹æ¬¡æœ‰æœºä¼šå†èŠ ğŸ™ƒ

## å†™åœ¨æœ€å

> We all earn our pay and reputations not by how we debug, but by how quickly and accurately we do it. â€”â€” Mark Russinovich

Mark Russinovich åœ¨ã€ŠWindows é«˜çº§è°ƒè¯•ã€‹åºè¨€é‡Œè¯´åˆ°ï¼šâ€œæˆ‘ä»¬çš„å·¥ä½œèƒ½åŠ›å¹¶ä¸åœ¨äºå¦‚ä½•è°ƒè¯•é—®é¢˜ï¼Œè€Œæ˜¯åœ¨äºè°ƒè¯•é—®é¢˜çš„é€Ÿåº¦å’Œå‡†ç¡®åº¦ã€‚â€

æ‰€ä»¥ï¼Œä¸€èµ·æŒ‚ä¸Šè°ƒè¯•å™¨ â€œé‡æ–°è®¤è¯†â€ ä¸–ç•Œå§ã€‚

æ„Ÿè°¢å…³æ³¨ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½å¯¹ä½ æœ‰å¸®åŠ©ã€‚å¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œ**æ¬¢è¿äº¤æµ**ã€‚ğŸ˜„

Delivered under MIT License &copy; 2021, BOT Man
